# 智慧建築自架雲平台 - 系統架構設計

**版本**: v1.0
**日期**: 2025/12/30
**目標場域**: 智慧建築
**控制設備**: 智取櫃 (自研) + 配送機器人 (多品牌)

---

## 目錄

1. [設計目標](#1-設計目標)
2. [原廠架構分析摘要](#2-原廠架構分析摘要)
3. [自架雲平台架構設計](#3-自架雲平台架構設計)
4. [多品牌機器人支援架構](#4-多品牌機器人支援架構)
5. [核心服務設計](#5-核心服務設計)
6. [通信協議設計](#6-通信協議設計)
7. [資料流設計](#7-資料流設計)
8. [資料庫設計](#8-資料庫設計)
9. [部署架構](#9-部署架構)
10. [技術選型](#10-技術選型)
11. [實施路線圖](#11-實施路線圖)

---

## 1. 設計目標

### 1.1 核心需求

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         自架雲平台設計目標                                 │
└──────────────────────────────────────────────────────────────────────────┘

1. 設備控制
   • 智取櫃 (Station): 艙門控制、狀態監控、儲格管理 (自研)
   • 配送機器人 (Robot): 任務調度、導航控制、狀態同步 (多品牌)

2. 多品牌機器人支援 ⭐ 關鍵需求
   • 統一的機器人抽象介面
   • 品牌專屬 Adapter 實現
   • 首先支援普渡機器人 (僅 API 對接)
   • 未來可擴展其他品牌

3. 核心功能
   • 任務管理: 創建、分配、追蹤、完成
   • 設備管理: 註冊、監控、狀態同步
   • 使用者介面: Web 後台、APP 通知

4. 設計原則
   • 模組化: Robot Adapter 可插拔
   • 可擴展: 支援新品牌機器人
   • 簡化架構: 降低維運複雜度
   • 高可用: 關鍵服務容錯
```

### 1.2 場域特性

| 項目 | 說明 |
|------|------|
| 場域類型 | 智慧建築 (社區/商辦) |
| 設備規模 | 1 大廳站 + 4 樓層站 + 2 Robot |
| 機器人品牌 | 普渡 (首先支援) + 未來其他品牌 |
| 網路環境 | 建築內 WiFi + 4G 備援 |
| 使用者 | 住戶、外送員、管理員 |

### 1.3 機器人對接現況

| 品牌 | 對接方式 | 本地通信 (2.4G) | 備註 |
|------|---------|----------------|------|
| **普渡** | REST API | ❌ 無 | 首先支援，透過雲端 API 控制 |
| 未來品牌 A | TBD | 可能有 | 預留架構 |
| 未來品牌 B | TBD | 可能有 | 預留架構 |

---

## 2. 原廠架構分析摘要

### 2.1 原廠核心設計模式

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         原廠雲平台核心特點                                 │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   1. 雙層通信架構                                                        │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  4G gRPC (遠程)              2.4G 無線 (近場)                    │   │
│   │  - 雲端任務調度               - Station-Robot 身份驗證            │   │
│   │  - 狀態同步                   - 艙門控制                          │   │
│   │  - 事件上報                   - 實時協作                          │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   2. 關鍵發現: 2.4G 本地通信                                             │
│   • 原廠 Robot 和 Station 透過 2.4G 進行本地協作                         │
│   • 實驗證明: 2.4G 斷線會導致 Robot 無法進入 Station                     │
│   • 普渡機器人沒有 2.4G → 需要雲端協調替代方案                           │
│                                                                          │
│   3. 技術棧                                                              │
│   • Kubernetes + DAPR + gRPC + Kafka                                    │
│   • TimescaleDB + Redis                                                 │
│   • Actor 模式狀態管理                                                   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 2.2 自架方案簡化對照

| 原廠設計 | 自架簡化方案 | 理由 |
|---------|-------------|------|
| K8s 多節點集群 | Docker Compose | 小規模，降低複雜度 |
| DAPR + Actor | 簡單狀態機 | 降低學習曲線 |
| Kafka | Redis Pub/Sub | 減少組件 |
| gRPC | REST + WebSocket | 易於調試 |
| 2.4G 本地協作 | 雲端協調模式 | 普渡無 2.4G |

---

## 3. 自架雲平台架構設計

### 3.1 整體架構圖

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         自架雲平台整體架構                                 │
└──────────────────────────────────────────────────────────────────────────┘

                                 ┌─────────────────┐
                                 │   使用者介面     │
                                 │  Web 後台       │
                                 │  住戶 APP       │
                                 │  外送員 APP     │
                                 └────────┬────────┘
                                          │ HTTPS / WebSocket
                                          │
┌─────────────────────────────────────────┼─────────────────────────────────┐
│                                         │                                  │
│                              ┌──────────▼──────────┐                      │
│                              │    API Gateway      │                      │
│                              │    (Nginx)          │                      │
│                              └──────────┬──────────┘                      │
│                                         │                                  │
│         ┌───────────────────────────────┼───────────────────────────────┐ │
│         │                               │                               │ │
│         ▼                               ▼                               ▼ │
│  ┌─────────────┐               ┌─────────────┐               ┌──────────┐│
│  │ Task Service│               │Device Service│              │Notif     ││
│  │             │               │             │               │Service   ││
│  │ - 任務 CRUD │               │ - Station   │               │          ││
│  │ - 任務分配  │◄─────────────►│   管理      │               │ - 推播   ││
│  │ - 狀態追蹤  │               │ - 心跳處理  │               │ - 通知   ││
│  └──────┬──────┘               └──────┬──────┘               └──────────┘│
│         │                             │                                   │
│         │        ┌────────────────────┴────────────────────┐             │
│         │        │                                         │             │
│         │        ▼                                         │             │
│         │ ┌─────────────────────────────────────────────┐ │             │
│         │ │          Robot Adapter Layer ⭐              │ │             │
│         │ │          (多品牌機器人抽象層)                 │ │             │
│         │ │                                              │ │             │
│         │ │  ┌──────────┐ ┌──────────┐ ┌──────────┐    │ │             │
│         │ │  │  Pudu    │ │ Brand A  │ │ Brand B  │    │ │             │
│         │ │  │ Adapter  │ │ Adapter  │ │ Adapter  │    │ │             │
│         │ │  │ (普渡)   │ │ (預留)   │ │ (預留)   │    │ │             │
│         │ │  └────┬─────┘ └──────────┘ └──────────┘    │ │             │
│         │ │       │ REST API                            │ │             │
│         │ └───────┼─────────────────────────────────────┘ │             │
│         │         │                                       │             │
│         └─────────┼───────────────────────────────────────┘             │
│                   │                                                      │
│  ┌────────────────┼──────────────────────────────────────────────────┐  │
│  │                │           Message Broker                          │  │
│  │                │           (Redis Pub/Sub)                         │  │
│  └────────────────┼──────────────────────────────────────────────────┘  │
│                   │                                                      │
│  ┌────────────────┼────────────────┐  ┌───────────────────────────────┐ │
│  │   PostgreSQL   │                │  │            Redis              │ │
│  └────────────────┼────────────────┘  └───────────────────────────────┘ │
│                   │                                                      │
│                   │              雲平台 (Cloud)                          │
└───────────────────┼──────────────────────────────────────────────────────┘
                    │
     ┌──────────────┼──────────────┬───────────────────┐
     │ WiFi         │              │ 普渡雲/API        │
     │              │              │                   │
     ▼              ▼              ▼                   ▼
┌─────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ 大廳站   │  │ 樓層站 x4   │  │ 普渡機器人  │  │ 未來品牌    │
│(Station)│  │  (Station)  │  │  (Pudu)     │  │  (預留)     │
│         │  │             │  │             │  │             │
│ WiFi    │  │ WiFi        │  │ WiFi/4G     │  │ TBD         │
└─────────┘  └─────────────┘  └─────────────┘  └─────────────┘
```

### 3.2 服務分層

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         服務分層架構                                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                      接入層 (Gateway)                            │   │
│   │  - Nginx: SSL 終止、JWT 驗證、路由、限流                         │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                      業務層 (Application)                        │   │
│   ├─────────────────┬─────────────────┬─────────────────────────────┤   │
│   │  Task Service   │ Device Service  │ Notification Service        │   │
│   │  - 任務調度引擎 │ - Station 管理  │ - 用戶通知推播              │   │
│   │  - 狀態機管理   │ - 心跳監控      │ - WebSocket 推送            │   │
│   │  - 分配算法     │                 │                             │   │
│   └─────────────────┴─────────────────┴─────────────────────────────┘   │
│                                    │                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │               Robot Adapter Layer (機器人抽象層) ⭐               │   │
│   │  - 統一介面定義                                                  │   │
│   │  - 品牌專屬 Adapter 實現                                         │   │
│   │  - 協議轉換、狀態映射                                            │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                      消息層 (Messaging)                          │   │
│   │  - Redis Pub/Sub (事件驅動)                                      │   │
│   │  - WebSocket (實時推送)                                          │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                      數據層 (Data)                               │   │
│   │  - PostgreSQL (持久化)                                           │   │
│   │  - Redis (快取 + 即時狀態)                                       │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 多品牌機器人支援架構

### 4.1 Robot Adapter 設計 ⭐ 核心設計

```
┌──────────────────────────────────────────────────────────────────────────┐
│                     Robot Adapter Layer 設計                              │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   設計目標:                                                              │
│   • 定義統一的機器人操作介面                                             │
│   • 各品牌實現各自的 Adapter                                             │
│   • 業務層只與抽象介面互動，不關心具體品牌                               │
│   • 新增品牌只需實現新 Adapter，不影響現有代碼                           │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                                                                   │   │
│   │                    Task Service / Device Service                  │   │
│   │                              │                                    │   │
│   │                              ▼                                    │   │
│   │           ┌─────────────────────────────────────┐                │   │
│   │           │     IRobotAdapter (統一介面)        │                │   │
│   │           │                                      │                │   │
│   │           │  • connect()                        │                │   │
│   │           │  • disconnect()                     │                │   │
│   │           │  • getStatus() → RobotStatus       │                │   │
│   │           │  • navigateTo(destination)         │                │   │
│   │           │  • executeTask(task)               │                │   │
│   │           │  • cancelTask(taskId)              │                │   │
│   │           │  • goCharge()                      │                │   │
│   │           │  • getPosition() → Position        │                │   │
│   │           │  • getBattery() → number           │                │   │
│   │           └───────────────┬─────────────────────┘                │   │
│   │                           │                                       │   │
│   │           ┌───────────────┼───────────────┐                      │   │
│   │           │               │               │                      │   │
│   │           ▼               ▼               ▼                      │   │
│   │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │   │
│   │   │PuduAdapter  │ │BrandAAdapter│ │BrandBAdapter│               │   │
│   │   │             │ │             │ │             │               │   │
│   │   │ 實現普渡API │ │ 預留擴展    │ │ 預留擴展    │               │   │
│   │   │ 對接邏輯    │ │             │ │             │               │   │
│   │   └──────┬──────┘ └─────────────┘ └─────────────┘               │   │
│   │          │                                                        │   │
│   │          ▼                                                        │   │
│   │   ┌─────────────┐                                                │   │
│   │   │ 普渡雲 API  │                                                │   │
│   │   └─────────────┘                                                │   │
│   │                                                                   │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 4.2 統一機器人介面定義

```typescript
// ===================================================================
// IRobotAdapter - 統一機器人介面
// ===================================================================

interface IRobotAdapter {
  // 基本資訊
  readonly brand: string;           // 品牌名稱 (e.g., "pudu", "keenon")
  readonly robotId: string;         // 機器人 ID

  // 連接管理
  connect(): Promise<void>;
  disconnect(): Promise<void>;
  isConnected(): boolean;

  // 狀態查詢
  getStatus(): Promise<RobotStatus>;
  getPosition(): Promise<Position>;
  getBattery(): Promise<number>;

  // 任務控制
  navigateTo(destination: Destination): Promise<TaskResult>;
  executeTask(task: RobotTask): Promise<TaskResult>;
  cancelTask(taskId: string): Promise<void>;
  pauseTask(taskId: string): Promise<void>;
  resumeTask(taskId: string): Promise<void>;

  // 其他控制
  goCharge(): Promise<void>;
  setSpeed(speed: number): Promise<void>;

  // 事件訂閱
  onStatusChange(callback: (status: RobotStatus) => void): void;
  onTaskProgress(callback: (progress: TaskProgress) => void): void;
  onError(callback: (error: RobotError) => void): void;
}

// ===================================================================
// 統一資料結構
// ===================================================================

interface RobotStatus {
  robotId: string;
  brand: string;
  state: RobotState;           // IDLE, NAVIGATING, EXECUTING, CHARGING, ERROR
  battery: number;             // 0-100
  position: Position;
  currentTaskId?: string;
  errorCode?: string;
  errorMessage?: string;
  updatedAt: Date;
}

enum RobotState {
  IDLE = 'IDLE',               // 閒置
  NAVIGATING = 'NAVIGATING',   // 導航中
  EXECUTING = 'EXECUTING',     // 執行任務中
  CHARGING = 'CHARGING',       // 充電中
  ERROR = 'ERROR',             // 異常
  OFFLINE = 'OFFLINE'          // 離線
}

interface Position {
  x: number;
  y: number;
  floor: number;
  mapId?: string;              // 地圖 ID (品牌專屬)
  orientation?: number;        // 朝向角度
}

interface Destination {
  type: 'STATION' | 'POI' | 'COORDINATE';
  stationId?: string;          // 智取櫃 ID
  poiId?: string;              // POI 點位 ID (品牌地圖中)
  coordinate?: Position;       // 坐標
  floor: number;
}

interface RobotTask {
  taskId: string;
  type: 'DELIVERY' | 'PICKUP' | 'GOTO' | 'CHARGE';
  source?: Destination;
  destination: Destination;
  priority: number;
  metadata?: Record<string, any>;
}

interface TaskResult {
  success: boolean;
  taskId: string;
  errorCode?: string;
  errorMessage?: string;
}

interface TaskProgress {
  taskId: string;
  status: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED' | 'FAILED' | 'CANCELLED';
  progress: number;            // 0-100
  currentStep?: string;
  estimatedTime?: number;      // 預估剩餘時間 (秒)
}
```

### 4.3 普渡 Adapter 實現

```
┌──────────────────────────────────────────────────────────────────────────┐
│                     PuduAdapter 實現設計                                  │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   普渡 API 對接要點:                                                     │
│   • 普渡提供 REST API 進行控制                                           │
│   • 無 2.4G 本地通信，所有控制透過雲端 API                               │
│   • 需要 API Key 認證                                                    │
│   • 支援 Webhook 回調 (任務狀態更新)                                     │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                                                                   │   │
│   │   class PuduAdapter implements IRobotAdapter {                    │   │
│   │                                                                   │   │
│   │     // 配置                                                       │   │
│   │     private apiKey: string;                                       │   │
│   │     private apiBaseUrl: string;                                   │   │
│   │     private robotSn: string;  // 普渡機器人序號                   │   │
│   │                                                                   │   │
│   │     // 狀態查詢 - 調用普渡 API                                    │   │
│   │     async getStatus(): Promise<RobotStatus> {                     │   │
│   │       const response = await this.callPuduApi(                    │   │
│   │         '/robot/status',                                          │   │
│   │         { robot_sn: this.robotSn }                                │   │
│   │       );                                                          │   │
│   │       return this.mapPuduStatusToStandard(response);             │   │
│   │     }                                                             │   │
│   │                                                                   │   │
│   │     // 導航控制 - 調用普渡 API                                    │   │
│   │     async navigateTo(dest: Destination): Promise<TaskResult> {    │   │
│   │       const puduPoi = this.mapDestinationToPuduPoi(dest);        │   │
│   │       const response = await this.callPuduApi(                    │   │
│   │         '/robot/navigate',                                        │   │
│   │         { robot_sn: this.robotSn, poi_id: puduPoi }              │   │
│   │       );                                                          │   │
│   │       return { success: response.code === 0, ... };              │   │
│   │     }                                                             │   │
│   │                                                                   │   │
│   │     // 狀態映射 - 普渡格式 → 標準格式                             │   │
│   │     private mapPuduStatusToStandard(puduStatus): RobotStatus {   │   │
│   │       return {                                                    │   │
│   │         robotId: this.robotId,                                    │   │
│   │         brand: 'pudu',                                            │   │
│   │         state: this.mapPuduState(puduStatus.status),             │   │
│   │         battery: puduStatus.battery,                              │   │
│   │         position: {                                               │   │
│   │           x: puduStatus.x,                                        │   │
│   │           y: puduStatus.y,                                        │   │
│   │           floor: puduStatus.floor                                 │   │
│   │         },                                                        │   │
│   │         ...                                                       │   │
│   │       };                                                          │   │
│   │     }                                                             │   │
│   │   }                                                               │   │
│   │                                                                   │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   POI 點位映射:                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                                                                   │   │
│   │   智取櫃 (Station)         普渡地圖 POI                          │   │
│   │   ──────────────────────────────────────────────────            │   │
│   │   station_lobby_001   ←→   poi_lobby_station                    │   │
│   │   station_floor_3     ←→   poi_floor_3_station                  │   │
│   │   station_floor_5     ←→   poi_floor_5_station                  │   │
│   │                                                                   │   │
│   │   * POI 映射表儲存於資料庫，可動態配置                           │   │
│   │                                                                   │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 4.4 Robot Adapter Manager

```
┌──────────────────────────────────────────────────────────────────────────┐
│                     Robot Adapter Manager                                 │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   職責:                                                                  │
│   • 管理所有已註冊的機器人 Adapter 實例                                  │
│   • 根據 robotId 取得對應的 Adapter                                      │
│   • 統一處理機器人事件分發                                               │
│                                                                          │
│   class RobotAdapterManager {                                            │
│                                                                          │
│     private adapters: Map<string, IRobotAdapter> = new Map();            │
│                                                                          │
│     // 註冊機器人                                                        │
│     registerRobot(robotId: string, brand: string, config: any): void {   │
│       const adapter = this.createAdapter(brand, robotId, config);        │
│       this.adapters.set(robotId, adapter);                               │
│       adapter.connect();                                                 │
│       this.setupEventListeners(adapter);                                 │
│     }                                                                    │
│                                                                          │
│     // 建立 Adapter (工廠模式)                                           │
│     private createAdapter(brand: string, ...): IRobotAdapter {           │
│       switch (brand) {                                                   │
│         case 'pudu':                                                     │
│           return new PuduAdapter(robotId, config);                       │
│         case 'keenon':                                                   │
│           return new KeenonAdapter(robotId, config); // 未來                │
│         default:                                                         │
│           throw new Error(`Unsupported brand: ${brand}`);               │
│       }                                                                  │
│     }                                                                    │
│                                                                          │
│     // 取得 Adapter                                                      │
│     getAdapter(robotId: string): IRobotAdapter {                         │
│       return this.adapters.get(robotId);                                 │
│     }                                                                    │
│                                                                          │
│     // 取得所有指定品牌的機器人                                          │
│     getRobotsByBrand(brand: string): IRobotAdapter[] {                   │
│       return Array.from(this.adapters.values())                          │
│         .filter(a => a.brand === brand);                                 │
│     }                                                                    │
│                                                                          │
│     // 統一事件處理                                                      │
│     private setupEventListeners(adapter: IRobotAdapter): void {          │
│       adapter.onStatusChange((status) => {                               │
│         this.publishEvent('robot.status', status);                       │
│       });                                                                │
│       adapter.onTaskProgress((progress) => {                             │
│         this.publishEvent('robot.task.progress', progress);              │
│       });                                                                │
│     }                                                                    │
│   }                                                                      │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 核心服務設計

### 5.1 Task Service (任務服務)

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         Task Service 設計                                 │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   職責:                                                                  │
│   1. 任務生命週期管理 (CRUD)                                             │
│   2. 任務分配決策 (選擇合適的機器人)                                     │
│   3. 任務狀態機維護                                                      │
│   4. 協調 Station 和 Robot 的協作                                        │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                      任務狀態機                                   │   │
│   │                                                                   │   │
│   │   ┌──────────┐     ┌──────────┐     ┌──────────────┐            │   │
│   │   │ CREATED  │────►│ ASSIGNED │────►│ ROBOT_MOVING │            │   │
│   │   └──────────┘     └──────────┘     └──────┬───────┘            │   │
│   │                                            │                     │   │
│   │                                            ▼                     │   │
│   │                                    ┌──────────────┐              │   │
│   │                                    │ROBOT_ARRIVED │              │   │
│   │                                    │ (到達Station) │              │   │
│   │                                    └──────┬───────┘              │   │
│   │                                           │                      │   │
│   │                                           ▼                      │   │
│   │                                    ┌──────────────┐              │   │
│   │                                    │STATION_OPEN  │              │   │
│   │                                    │ (艙門開啟)   │              │   │
│   │                                    └──────┬───────┘              │   │
│   │                                           │                      │   │
│   │                                           ▼                      │   │
│   │                                    ┌──────────────┐              │   │
│   │                                    │ TRANSFERRING │              │   │
│   │                                    │ (取/放包裹)  │              │   │
│   │                                    └──────┬───────┘              │   │
│   │                                           │                      │   │
│   │                          ┌────────────────┼────────────────┐    │   │
│   │                          ▼                ▼                ▼    │   │
│   │                   ┌──────────┐     ┌──────────┐     ┌────────┐  │   │
│   │                   │DELIVERING│     │  FAILED  │     │CANCELLED│  │   │
│   │                   │(配送中)  │     └──────────┘     └────────┘  │   │
│   │                   └────┬─────┘                                   │   │
│   │                        │                                         │   │
│   │                        ▼                                         │   │
│   │                 ┌──────────┐                                     │   │
│   │                 │COMPLETED │                                     │   │
│   │                 └──────────┘                                     │   │
│   │                                                                   │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   API 端點:                                                              │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ POST   /api/v1/tasks              創建任務                       │   │
│   │ GET    /api/v1/tasks              查詢任務列表                   │   │
│   │ GET    /api/v1/tasks/:id          查詢單一任務                   │   │
│   │ PUT    /api/v1/tasks/:id/cancel   取消任務                       │   │
│   │ GET    /api/v1/tasks/:id/progress 查詢任務進度                   │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Device Service (設備服務)

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         Device Service 設計                               │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   職責:                                                                  │
│   1. Station (智取櫃) 管理                                               │
│   2. 心跳處理與狀態同步                                                  │
│   3. 艙門控制指令下發                                                    │
│   4. 機器人狀態聚合 (透過 Adapter Manager)                               │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                      設備類型                                     │   │
│   │                                                                   │   │
│   │   類型              說明              通信方式                    │   │
│   │   ─────────────────────────────────────────────────────────     │   │
│   │   STATION_LOBBY     大廳站            WebSocket (自研)            │   │
│   │   STATION_FLOOR     樓層站            WebSocket (自研)            │   │
│   │   ROBOT_PUDU        普渡機器人        REST API (普渡雲)           │   │
│   │   ROBOT_OTHER       其他品牌機器人    依品牌而定                   │   │
│   │                                                                   │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   API 端點:                                                              │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ # Station 管理                                                    │   │
│   │ POST   /api/v1/stations/register      Station 註冊               │   │
│   │ GET    /api/v1/stations               Station 列表               │   │
│   │ GET    /api/v1/stations/:id           Station 詳情               │   │
│   │ GET    /api/v1/stations/:id/status    Station 即時狀態           │   │
│   │ POST   /api/v1/stations/:id/command   下發指令 (開門等)          │   │
│   │                                                                   │   │
│   │ # Robot 管理 (透過 Adapter)                                       │   │
│   │ POST   /api/v1/robots/register        Robot 註冊                 │   │
│   │ GET    /api/v1/robots                 Robot 列表                 │   │
│   │ GET    /api/v1/robots/:id             Robot 詳情                 │   │
│   │ GET    /api/v1/robots/:id/status      Robot 即時狀態             │   │
│   │ POST   /api/v1/robots/:id/navigate    導航到指定位置             │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   WebSocket 端點 (Station 長連接):                                       │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ WS /ws/station/:station_id                                       │   │
│   │                                                                   │   │
│   │ 上行消息 (Station → Cloud):                                       │   │
│   │   - heartbeat      心跳 (每 10 秒)                                │   │
│   │   - status_update  狀態更新 (儲格狀態變化)                        │   │
│   │   - event          事件上報 (開門、關門、包裹進出)                │   │
│   │                                                                   │   │
│   │ 下行消息 (Cloud → Station):                                       │   │
│   │   - command        指令 (OPEN_DOOR, CLOSE_DOOR)                  │   │
│   │   - config_update  配置更新                                       │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 通信協議設計

### 6.1 通信架構總覽

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         通信架構設計                                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ⚠️ 關鍵差異: 普渡機器人無 2.4G 本地通信                                │
│   → Station 和 Robot 的協作全部透過雲平台協調                            │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                                                                   │   │
│   │                        ┌──────────────┐                          │   │
│   │                        │   雲平台      │                          │   │
│   │                        │              │                          │   │
│   │                        │ ┌──────────┐ │                          │   │
│   │                        │ │協調引擎  │ │                          │   │
│   │                        │ └────┬─────┘ │                          │   │
│   │                        └──────┼───────┘                          │   │
│   │                               │                                   │   │
│   │              ┌────────────────┼────────────────┐                 │   │
│   │              │                │                │                 │   │
│   │              ▼                │                ▼                 │   │
│   │    ┌─────────────────┐       │      ┌─────────────────┐         │   │
│   │    │    Station      │       │      │  普渡機器人     │         │   │
│   │    │                 │       │      │                 │         │   │
│   │    │  WebSocket      │       │      │  REST API       │         │   │
│   │    │  (自研協議)     │       │      │  (普渡 API)     │         │   │
│   │    └─────────────────┘       │      └─────────────────┘         │   │
│   │                               │                                   │   │
│   │                          無直接通信                               │   │
│   │                         (無 2.4G)                                │   │
│   │                                                                   │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   通信方式對照:                                                          │
│   ┌────────────┬────────────────┬────────────────────────────────────┐ │
│   │ 設備       │ 協議           │ 說明                               │ │
│   ├────────────┼────────────────┼────────────────────────────────────┤ │
│   │ Station    │ WebSocket      │ 自研協議，長連接，即時雙向通信     │ │
│   │ 普渡 Robot │ REST API       │ 普渡提供的 API，輪詢或 Webhook     │ │
│   │ 未來 Robot │ TBD            │ 依品牌而定                         │ │
│   └────────────┴────────────────┴────────────────────────────────────┘ │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Station-Robot 協作流程 (雲端協調模式)

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    Station-Robot 協作 (無 2.4G 版本)                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   由於普渡機器人沒有 2.4G，Station 和 Robot 的協作由雲平台協調:           │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                                                                   │   │
│   │   雲平台                     Station                  Robot      │   │
│   │      │                          │                       │        │   │
│   │      │  1. 分配任務到 Robot    │                       │        │   │
│   │      ├─────────────────────────────────────────────────►│        │   │
│   │      │                          │                       │        │   │
│   │      │                          │  2. Robot 開始導航    │        │   │
│   │      │◄─────────────────────────────────────────────────┤        │   │
│   │      │     (狀態: NAVIGATING)   │                       │        │   │
│   │      │                          │                       │        │   │
│   │      │  3. Robot 到達 Station 附近                      │        │   │
│   │      │◄─────────────────────────────────────────────────┤        │   │
│   │      │     (位置更新)           │                       │        │   │
│   │      │                          │                       │        │   │
│   │      │  4. 雲平台確認 Robot 位置，指示 Station 開門     │        │   │
│   │      ├─────────────────────────►│                       │        │   │
│   │      │     (命令: OPEN_DOOR)    │                       │        │   │
│   │      │                          │                       │        │   │
│   │      │  5. Station 開門         │                       │        │   │
│   │      │◄─────────────────────────┤                       │        │   │
│   │      │     (事件: DOOR_OPENED)  │                       │        │   │
│   │      │                          │                       │        │   │
│   │      │  6. 通知 Robot 可以取/放包裹                     │        │   │
│   │      ├─────────────────────────────────────────────────►│        │   │
│   │      │                          │                       │        │   │
│   │      │  7. Robot 完成操作       │                       │        │   │
│   │      │◄─────────────────────────────────────────────────┤        │   │
│   │      │     (狀態: TASK_DONE)    │                       │        │   │
│   │      │                          │                       │        │   │
│   │      │  8. 指示 Station 關門    │                       │        │   │
│   │      ├─────────────────────────►│                       │        │   │
│   │      │     (命令: CLOSE_DOOR)   │                       │        │   │
│   │      │                          │                       │        │   │
│   │      │  9. Station 關門         │                       │        │   │
│   │      │◄─────────────────────────┤                       │        │   │
│   │      │     (事件: DOOR_CLOSED)  │                       │        │   │
│   │      │                          │                       │        │   │
│   │                                                                   │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   協調邏輯關鍵點:                                                        │
│   • Robot 到達判定: 根據 Robot 位置與 Station 位置的距離 (< 1m)          │
│   • 開門時機: 雲平台確認 Robot 已到達後，主動下發開門指令                │
│   • 超時處理: 開門後若 Robot 未操作，30 秒後自動關門                     │
│   • 錯誤恢復: 任一方異常時，雲平台負責協調重試或取消                     │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 6.3 消息格式設計

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         消息格式設計                                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   Station WebSocket 消息格式:                                            │
│   ─────────────────────────────────────────────────────────────────     │
│                                                                          │
│   基礎結構:                                                              │
│   {                                                                      │
│     "type": "string",           // 消息類型                              │
│     "stationId": "string",      // Station ID                            │
│     "timestamp": "ISO8601",     // 時間戳                                │
│     "payload": {}               // 消息內容                              │
│   }                                                                      │
│                                                                          │
│   上行消息 (Station → Cloud):                                            │
│                                                                          │
│   1. 心跳                                                                │
│   {                                                                      │
│     "type": "heartbeat",                                                 │
│     "stationId": "station_lobby_001",                                    │
│     "timestamp": "2025-12-30T10:00:00Z",                                 │
│     "payload": {                                                         │
│       "status": "online",                                                │
│       "lockers": [                                                       │
│         {"id": "L01", "size": "S", "status": "empty"},                   │
│         {"id": "L02", "size": "M", "status": "occupied"},                │
│         ...                                                              │
│       ]                                                                  │
│     }                                                                    │
│   }                                                                      │
│                                                                          │
│   2. 事件上報                                                            │
│   {                                                                      │
│     "type": "event",                                                     │
│     "stationId": "station_floor_3",                                      │
│     "timestamp": "2025-12-30T10:01:00Z",                                 │
│     "payload": {                                                         │
│       "eventType": "DOOR_OPENED",    // DOOR_OPENED, DOOR_CLOSED,        │
│                                       // PARCEL_IN, PARCEL_OUT          │
│       "lockerId": "L03",                                                 │
│       "taskId": "task_001"                                               │
│     }                                                                    │
│   }                                                                      │
│                                                                          │
│   下行消息 (Cloud → Station):                                            │
│                                                                          │
│   1. 開門指令                                                            │
│   {                                                                      │
│     "type": "command",                                                   │
│     "stationId": "station_lobby_001",                                    │
│     "timestamp": "2025-12-30T10:02:00Z",                                 │
│     "payload": {                                                         │
│       "command": "OPEN_DOOR",                                            │
│       "lockerId": "L05",                                                 │
│       "taskId": "task_001",                                              │
│       "timeout": 30,                    // 自動關門超時 (秒)             │
│       "reason": "robot_pickup"          // 開門原因                      │
│     }                                                                    │
│   }                                                                      │
│                                                                          │
│   2. 關門指令                                                            │
│   {                                                                      │
│     "type": "command",                                                   │
│     "stationId": "station_lobby_001",                                    │
│     "timestamp": "2025-12-30T10:03:00Z",                                 │
│     "payload": {                                                         │
│       "command": "CLOSE_DOOR",                                           │
│       "lockerId": "L05"                                                  │
│     }                                                                    │
│   }                                                                      │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 資料流設計

### 7.1 收件流程 (外送員 → 住戶)

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         收件流程資料流                                    │
└──────────────────────────────────────────────────────────────────────────┘

 外送員        大廳站           雲平台              Robot           樓層站        住戶
    │            │               │                   │               │            │
    │  1. 掃碼投件               │                   │               │            │
    ├───────────►│               │                   │               │            │
    │            │               │                   │               │            │
    │            │ 2. 上報事件    │                   │               │            │
    │            │ PARCEL_IN     │                   │               │            │
    │            ├──────────────►│                   │               │            │
    │            │  (WebSocket)  │                   │               │            │
    │            │               │                   │               │            │
    │            │               │ 3. 創建任務       │               │            │
    │            │               │ 選擇可用Robot     │               │            │
    │            │               │                   │               │            │
    │            │               │ 4. 透過 Adapter   │               │            │
    │            │               │    分配任務       │               │            │
    │            │               ├──────────────────►│               │            │
    │            │               │   (REST API)      │               │            │
    │            │               │                   │               │            │
    │            │               │                   │ 5. Robot 導航 │            │
    │            │               │◄──────────────────┤ 到大廳站      │            │
    │            │               │  (位置更新)       │               │            │
    │            │               │                   │               │            │
    │            │               │ 6. 確認到達      │               │            │
    │            │               │    開門指令       │               │            │
    │            ├◄──────────────┤                   │               │            │
    │            │  (WebSocket)  │                   │               │            │
    │            │               │                   │               │            │
    │            │ 7. 開門       │                   │               │            │
    │            ├──────────────►│                   │               │            │
    │            │  DOOR_OPENED  │                   │               │            │
    │            │               │                   │               │            │
    │            │               │ 8. 通知 Robot    │               │            │
    │            │               │    可以取件       │               │            │
    │            │               ├──────────────────►│               │            │
    │            │               │                   │               │            │
    │            │               │                   │ 9. Robot 取件 │            │
    │            │               │◄──────────────────┤ 完成          │            │
    │            │               │                   │               │            │
    │            │               │ 10. 關門指令     │               │            │
    │            ├◄──────────────┤                   │               │            │
    │            │               │                   │               │            │
    │            │               │ 11. Robot 導航   │               │            │
    │            │               │     到樓層站      │               │            │
    │            │               │                   │──────────────►│            │
    │            │               │                   │               │            │
    │            │               │ 12. 確認到達     │               │            │
    │            │               │     開門指令      │               │            │
    │            │               ├──────────────────────────────────►│            │
    │            │               │                   │               │            │
    │            │               │ 13. Robot 投件   │               │            │
    │            │               │◄──────────────────┤               │            │
    │            │               │                   │               │            │
    │            │               │ 14. 任務完成     │               │            │
    │            │               │     推播通知      │               │            │
    │            │               ├────────────────────────────────────────────────►│
    │            │               │                   │               │            │
    │            │               │                   │               │ 15. 取件   │
    │            │               │                   │               │◄───────────┤
```

### 7.2 狀態同步資料流

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         狀態同步資料流                                    │
└──────────────────────────────────────────────────────────────────────────┘

   Station                    雲平台                     Robot (via Adapter)
      │                          │                             │
      │ ═══════ WebSocket 長連接 ═══════                      │
      │                          │                             │
      │  心跳 (每 10 秒)         │                             │
      ├─────────────────────────►│                             │
      │                          │  更新 Redis                 │
      │                          │  station:status:{id}        │
      │                          │                             │
      │                          │  輪詢 Robot 狀態            │
      │                          │  (或 Webhook 回調)          │
      │                          │◄────────────────────────────┤
      │                          │                             │
      │                          │  更新 Redis                 │
      │                          │  robot:status:{id}          │
      │                          │                             │
      │  事件上報                │                             │
      │  (DOOR_OPENED, etc)     │                             │
      ├─────────────────────────►│                             │
      │                          │  發布事件                   │
      │                          │  Redis Pub/Sub              │
      │                          │                             │
      │                          │  Task Service               │
      │                          │  訂閱處理                   │
      │                          │                             │
      │                          │  Notification               │
      │                          │  推播用戶                   │
      │                          │                             │

   狀態儲存:
   ┌─────────────────────────────────────────────────────────────────┐
   │ Redis                                                           │
   │                                                                 │
   │ station:status:station_lobby_001                                │
   │ {                                                               │
   │   "status": "online",                                           │
   │   "lastHeartbeat": "2025-12-30T10:00:00Z",                      │
   │   "lockers": {...}                                              │
   │ }                                                               │
   │                                                                 │
   │ robot:status:robot_pudu_001                                     │
   │ {                                                               │
   │   "brand": "pudu",                                              │
   │   "state": "IDLE",                                              │
   │   "battery": 85,                                                │
   │   "position": {"x": 10.5, "y": 20.3, "floor": 1},              │
   │   "lastUpdate": "2025-12-30T10:00:05Z"                         │
   │ }                                                               │
   └─────────────────────────────────────────────────────────────────┘
```

---

## 8. 資料庫設計

### 8.1 PostgreSQL Schema

```sql
-- ====================================================================
-- 自架雲平台資料庫設計
-- ====================================================================

-- 1. 用戶表
CREATE TABLE users (
    id              SERIAL PRIMARY KEY,
    username        VARCHAR(50) UNIQUE NOT NULL,
    password_hash   VARCHAR(255) NOT NULL,
    role            VARCHAR(20) NOT NULL,  -- ADMIN, RESIDENT, COURIER, OPERATOR
    name            VARCHAR(100),
    phone           VARCHAR(20),
    email           VARCHAR(100),
    unit_number     VARCHAR(20),           -- 住戶房號
    created_at      TIMESTAMP DEFAULT NOW(),
    updated_at      TIMESTAMP DEFAULT NOW()
);

-- 2. Station 表 (智取櫃)
CREATE TABLE stations (
    id              SERIAL PRIMARY KEY,
    station_id      VARCHAR(50) UNIQUE NOT NULL,
    station_type    VARCHAR(30) NOT NULL,  -- STATION_LOBBY, STATION_FLOOR
    name            VARCHAR(100),
    location        VARCHAR(100),
    floor           INTEGER,
    locker_config   JSONB,                 -- 儲格配置
    status          VARCHAR(20) DEFAULT 'offline',
    last_heartbeat  TIMESTAMP,
    created_at      TIMESTAMP DEFAULT NOW()
);

-- 3. 儲格表
CREATE TABLE lockers (
    id              SERIAL PRIMARY KEY,
    station_id      VARCHAR(50) NOT NULL REFERENCES stations(station_id),
    locker_id       VARCHAR(10) NOT NULL,
    size            VARCHAR(5) NOT NULL,   -- S, M, L
    status          VARCHAR(20) DEFAULT 'empty',  -- empty, occupied, reserved
    current_task_id INTEGER,
    UNIQUE(station_id, locker_id)
);

-- 4. Robot 表 (機器人)
CREATE TABLE robots (
    id              SERIAL PRIMARY KEY,
    robot_id        VARCHAR(50) UNIQUE NOT NULL,
    brand           VARCHAR(30) NOT NULL,  -- pudu, keenon, etc.
    name            VARCHAR(100),
    model           VARCHAR(50),
    config          JSONB,                 -- 品牌專屬配置 (API key, SN 等)
    poi_mapping     JSONB,                 -- POI 映射表
    status          VARCHAR(20) DEFAULT 'offline',
    created_at      TIMESTAMP DEFAULT NOW()
);

-- 5. 任務表
CREATE TABLE tasks (
    id              SERIAL PRIMARY KEY,
    task_uuid       UUID DEFAULT gen_random_uuid(),
    task_type       VARCHAR(20) NOT NULL,  -- DELIVERY, PICKUP
    status          VARCHAR(30) NOT NULL,  -- CREATED, ASSIGNED, ROBOT_MOVING,
                                           -- ROBOT_ARRIVED, STATION_OPEN,
                                           -- TRANSFERRING, DELIVERING,
                                           -- COMPLETED, FAILED, CANCELLED

    -- 來源
    source_station_id VARCHAR(50),
    source_locker_id  VARCHAR(10),
    source_user_id    INTEGER REFERENCES users(id),

    -- 目的地
    dest_floor        INTEGER,
    dest_room         VARCHAR(20),
    dest_station_id   VARCHAR(50),
    dest_locker_id    VARCHAR(10),
    dest_user_id      INTEGER REFERENCES users(id),

    -- 分配
    assigned_robot_id VARCHAR(50),
    assigned_at       TIMESTAMP,

    -- 包裹
    parcel_code       VARCHAR(50),
    parcel_size       VARCHAR(5),

    -- 時間
    created_at        TIMESTAMP DEFAULT NOW(),
    completed_at      TIMESTAMP,

    -- 擴展
    metadata          JSONB
);

-- 6. 任務事件記錄
CREATE TABLE task_events (
    id              SERIAL PRIMARY KEY,
    task_id         INTEGER NOT NULL REFERENCES tasks(id),
    event_type      VARCHAR(30) NOT NULL,
    device_id       VARCHAR(50),
    device_type     VARCHAR(20),           -- STATION, ROBOT
    details         JSONB,
    created_at      TIMESTAMP DEFAULT NOW()
);

-- 7. POI 映射表 (品牌專屬 POI 與 Station 對應)
CREATE TABLE poi_mappings (
    id              SERIAL PRIMARY KEY,
    robot_brand     VARCHAR(30) NOT NULL,
    station_id      VARCHAR(50) NOT NULL,
    poi_id          VARCHAR(50) NOT NULL,  -- 品牌地圖中的 POI ID
    poi_name        VARCHAR(100),
    floor           INTEGER,
    UNIQUE(robot_brand, station_id)
);

-- 8. 通知表
CREATE TABLE notifications (
    id              SERIAL PRIMARY KEY,
    user_id         INTEGER NOT NULL REFERENCES users(id),
    task_id         INTEGER REFERENCES tasks(id),
    type            VARCHAR(30) NOT NULL,
    title           VARCHAR(100),
    message         TEXT,
    is_read         BOOLEAN DEFAULT FALSE,
    created_at      TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_assigned_robot ON tasks(assigned_robot_id);
CREATE INDEX idx_task_events_task_id ON task_events(task_id);
CREATE INDEX idx_poi_mappings_brand ON poi_mappings(robot_brand);
```

### 8.2 Redis 資料結構

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         Redis 資料結構                                    │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   1. Station 即時狀態 (Hash)                                             │
│   Key: station:status:{station_id}                                       │
│   TTL: 60 秒                                                             │
│   Fields:                                                                │
│     - status: "online" | "offline"                                       │
│     - lastHeartbeat: ISO8601                                             │
│     - lockers: JSON (儲格狀態)                                           │
│                                                                          │
│   2. Robot 即時狀態 (Hash)                                               │
│   Key: robot:status:{robot_id}                                           │
│   TTL: 60 秒                                                             │
│   Fields:                                                                │
│     - brand: "pudu"                                                      │
│     - state: "IDLE" | "NAVIGATING" | "EXECUTING" | ...                   │
│     - battery: 85                                                        │
│     - position: JSON                                                     │
│     - currentTaskId: "task_001"                                          │
│     - lastUpdate: ISO8601                                                │
│                                                                          │
│   3. 任務即時狀態 (Hash)                                                 │
│   Key: task:status:{task_id}                                             │
│   TTL: 24 小時                                                           │
│   Fields:                                                                │
│     - status: "ASSIGNED" | "ROBOT_MOVING" | ...                          │
│     - assignedRobot: "robot_001"                                         │
│     - progress: 60                                                       │
│     - currentStep: "navigating_to_lobby"                                 │
│                                                                          │
│   4. 線上設備 (Set)                                                      │
│   Key: devices:online:stations                                           │
│   Key: devices:online:robots                                             │
│                                                                          │
│   5. Pub/Sub Channels                                                    │
│   - task.created                                                         │
│   - task.status.{task_id}                                                │
│   - station.event.{station_id}                                           │
│   - robot.status.{robot_id}                                              │
│   - notification.{user_id}                                               │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 部署架構

### 9.1 Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  # ================================
  # 基礎設施
  # ================================
  postgres:
    image: postgres:15
    container_name: cloud_postgres
    environment:
      POSTGRES_USER: cloudadmin
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: smart_building
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    restart: always

  redis:
    image: redis:7-alpine
    container_name: cloud_redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: always

  # ================================
  # 應用服務
  # ================================
  nginx:
    image: nginx:alpine
    container_name: cloud_nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - api
      - websocket
    restart: always

  api:
    build: ./services/api
    container_name: cloud_api
    environment:
      - DATABASE_URL=postgresql://cloudadmin:${DB_PASSWORD}@postgres:5432/smart_building
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres
      - redis
    restart: always

  websocket:
    build: ./services/websocket
    container_name: cloud_websocket
    environment:
      - REDIS_URL=redis://redis:6379
      - API_URL=http://api:8000
    depends_on:
      - redis
      - api
    ports:
      - "8080:8080"
    restart: always

  # Robot Adapter Service (獨立服務)
  robot-adapter:
    build: ./services/robot-adapter
    container_name: cloud_robot_adapter
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://cloudadmin:${DB_PASSWORD}@postgres:5432/smart_building
      - PUDU_API_KEY=${PUDU_API_KEY}
      - PUDU_API_URL=${PUDU_API_URL}
    depends_on:
      - redis
      - postgres
    restart: always

volumes:
  postgres_data:
  redis_data:
```

### 9.2 系統需求

| 項目 | 建議配置 |
|------|---------|
| 伺服器 | 4 Core / 8GB RAM / 100GB SSD |
| 作業系統 | Ubuntu 22.04 LTS |
| Docker | 24.0+ |
| 網路 | 固定 IP，開放 80/443/8080 |

---

## 10. 技術選型

### 10.1 技術棧

| 層級 | 技術 | 說明 |
|------|-----|------|
| **後端** | Python 3.11+ / FastAPI | 高效能、易於開發 |
| **WebSocket** | FastAPI WebSocket 或 Socket.IO | Station 長連接 |
| **資料庫** | PostgreSQL 15 | 穩定、功能完整 |
| **快取** | Redis 7 | 即時狀態 + Pub/Sub |
| **容器** | Docker Compose | 簡化部署 |
| **網關** | Nginx | SSL、路由、限流 |
| **前端** | Vue 3 + TypeScript | 管理後台 |

### 10.2 Robot Adapter 實現語言

建議使用 **Python**:
- 普渡 API 呼叫簡單 (requests)
- 未來擴展其他品牌 SDK 多有 Python 支援
- 與主服務一致，降低維護成本

---

## 11. 實施路線圖

### 11.1 階段規劃

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         實施路線圖                                        │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   階段 1: 基礎建設                                                       │
│   ─────────────────────────────────────────────────────────────────     │
│   • 環境準備 (伺服器、Docker、SSL)                                       │
│   • PostgreSQL + Redis 部署                                              │
│   • 資料庫 Schema 建立                                                   │
│   • API 框架搭建 (FastAPI)                                               │
│   • 用戶認證 (JWT)                                                       │
│                                                                          │
│   階段 2: Station 通信                                                   │
│   ─────────────────────────────────────────────────────────────────     │
│   • WebSocket 服務開發                                                   │
│   • Station 註冊與心跳                                                   │
│   • Station 狀態同步                                                     │
│   • 艙門控制指令                                                         │
│   • Station 模擬器 (測試)                                                │
│                                                                          │
│   階段 3: Robot Adapter 層                                               │
│   ─────────────────────────────────────────────────────────────────     │
│   • IRobotAdapter 介面定義                                               │
│   • RobotAdapterManager 實現                                             │
│   • PuduAdapter 實現 (普渡 API 對接)                                     │
│   • Robot 狀態輪詢/Webhook                                               │
│                                                                          │
│   階段 4: 任務管理                                                       │
│   ─────────────────────────────────────────────────────────────────     │
│   • 任務 CRUD API                                                        │
│   • 任務狀態機                                                           │
│   • Station-Robot 協調邏輯                                               │
│   • 任務分配演算法                                                       │
│                                                                          │
│   階段 5: 整合測試                                                       │
│   ─────────────────────────────────────────────────────────────────     │
│   • 完整流程測試 (收件/寄件)                                             │
│   • 異常處理測試                                                         │
│   • 壓力測試                                                             │
│                                                                          │
│   階段 6: 前端與上線                                                     │
│   ─────────────────────────────────────────────────────────────────     │
│   • Web 管理後台                                                         │
│   • 住戶 APP / 小程序                                                    │
│   • 現場部署                                                             │
│   • 監控告警                                                             │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 11.2 MVP 功能清單

| 優先級 | 功能 | 說明 |
|-------|-----|------|
| **P0** | Station WebSocket 通信 | 核心 |
| **P0** | PuduAdapter 基本功能 | 普渡 API 對接 |
| **P0** | 任務創建與分配 | 核心流程 |
| **P0** | Station-Robot 協調 | 雲端協調開門 |
| **P1** | 收件完整流程 | 外送員→住戶 |
| **P1** | 用戶認證 | JWT |
| **P2** | 寄件流程 | 住戶→快遞員 |
| **P2** | 通知推播 | WebSocket |
| **P3** | Web 管理後台 | |
| **P3** | 數據統計 | |

---

## 附錄 A: 普渡 API 對接參考

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         普渡 API 對接參考                                 │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ⚠️ 以下為示意，實際 API 以普渡官方文檔為準                              │
│                                                                          │
│   認證:                                                                  │
│   - API Key 放在 Header: X-API-Key                                       │
│                                                                          │
│   常用 API:                                                              │
│   ┌────────────────────────────────────────────────────────────────┐    │
│   │                                                                  │    │
│   │ # 查詢機器人狀態                                                 │    │
│   │ GET /api/v1/robots/{robot_sn}/status                            │    │
│   │ Response:                                                        │    │
│   │ {                                                                │    │
│   │   "robot_sn": "PUDU123456",                                     │    │
│   │   "status": "idle",  // idle, navigating, charging              │    │
│   │   "battery": 85,                                                 │    │
│   │   "x": 10.5,                                                     │    │
│   │   "y": 20.3,                                                     │    │
│   │   "floor": 1                                                     │    │
│   │ }                                                                │    │
│   │                                                                  │    │
│   │ # 導航到指定 POI                                                 │    │
│   │ POST /api/v1/robots/{robot_sn}/navigate                         │    │
│   │ Body: { "poi_id": "poi_lobby_station" }                         │    │
│   │                                                                  │    │
│   │ # 回充電站                                                       │    │
│   │ POST /api/v1/robots/{robot_sn}/charge                           │    │
│   │                                                                  │    │
│   │ # 取消當前任務                                                   │    │
│   │ POST /api/v1/robots/{robot_sn}/cancel                           │    │
│   │                                                                  │    │
│   └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│   Webhook 回調 (可選):                                                   │
│   - 普渡可配置 Webhook，當機器人狀態變化時主動通知                       │
│   - 減少輪詢頻率，提高即時性                                             │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 附錄 B: 擴展新品牌機器人指南

```
┌──────────────────────────────────────────────────────────────────────────┐
│                     擴展新品牌機器人步驟                                   │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   1. 建立新 Adapter 類別                                                 │
│   ─────────────────────────────────────────────────────────────────     │
│   class NewBrandAdapter(IRobotAdapter):                                  │
│       brand = "newbrand"                                                 │
│                                                                          │
│       def __init__(self, robot_id: str, config: dict):                   │
│           self.robot_id = robot_id                                       │
│           self.api_key = config["api_key"]                               │
│           # ... 初始化                                                   │
│                                                                          │
│       async def get_status(self) -> RobotStatus:                         │
│           # 實現品牌專屬 API 呼叫                                        │
│           response = await self.call_brand_api("/status")                │
│           return self.map_to_standard(response)                          │
│                                                                          │
│       async def navigate_to(self, dest: Destination) -> TaskResult:      │
│           # 實現導航控制                                                 │
│           ...                                                            │
│                                                                          │
│   2. 註冊到 AdapterManager                                               │
│   ─────────────────────────────────────────────────────────────────     │
│   # robot_adapter_manager.py                                             │
│   def create_adapter(brand: str, ...):                                   │
│       if brand == "pudu":                                                │
│           return PuduAdapter(...)                                        │
│       elif brand == "newbrand":      # 新增                              │
│           return NewBrandAdapter(...)                                    │
│                                                                          │
│   3. 配置 POI 映射                                                       │
│   ─────────────────────────────────────────────────────────────────     │
│   INSERT INTO poi_mappings (robot_brand, station_id, poi_id, floor)      │
│   VALUES ('newbrand', 'station_lobby_001', 'newbrand_poi_123', 1);       │
│                                                                          │
│   4. 資料庫新增機器人                                                    │
│   ─────────────────────────────────────────────────────────────────     │
│   INSERT INTO robots (robot_id, brand, name, config)                     │
│   VALUES ('robot_new_001', 'newbrand', '新品牌機器人1',                   │
│           '{"api_key": "xxx", "api_url": "https://..."}');               │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

**文件版本**: v1.0
**日期**: 2025/12/30
**作者**: 基於原廠架構分析設計
