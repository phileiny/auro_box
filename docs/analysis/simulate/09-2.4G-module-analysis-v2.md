# 2.4G 通訊模組分析

**文檔版本**: v2.0  
**最後更新**: 2025-12-08  
**狀態**: ✅ 已確認硬體

---

## 目錄

1. [硬體確認結果](#硬體確認結果) ⭐ 新增
2. [系統中 2.4G 的角色](#系統中-24g-的角色)
3. [為什麼需要 2.4G](#為什麼需要-24g)
4. [業界常見 2.4G 方案](#業界常見-24g-方案)
5. [EBYTE E01 模組規格](#ebyte-e01-模組規格) ⭐ 新增
6. [2.4G 通訊協議分析](#24g-通訊協議分析)
7. [自研 Station 的路線選擇](#自研-station-的路線選擇)
8. [類似架構的商用案例](#類似架構的商用案例)
9. [目前已知 vs 未知](#目前已知-vs-未知)
10. [下一步行動](#下一步行動)

---

## 硬體確認結果

### 實機照片分析

經拆機確認，Station 艙門控制板使用的 2.4G 模組已辨識：

```
┌─────────────────────────────────────────────────────────────────┐
│                     Station 艙門控制板                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────┐                       │
│   │  綠色板（2.4G 模組）                 │                       │
│   │                                     │                       │
│   │  板子標示: "GO Robot"               │ ← YOGO Robot 自製     │
│   │  無線模組: EBYTE E01（金色金屬罩）   │ ← 關鍵發現！          │
│   │  認證標誌: CE                       │                       │
│   │  核心晶片: Nordic nRF24L01P         │                       │
│   │                                     │                       │
│   └─────────────────────────────────────┘                       │
│                     │                                           │
│                     │ 連接                                      │
│                     ▼                                           │
│   ┌─────────────────────────────────────┐                       │
│   │  黑色板（主控板）                    │                       │
│   │                                     │                       │
│   │  MCU: ARM 晶片                      │                       │
│   │  輸入電壓: 12-24V                   │                       │
│   │  繼電器: OMRON（控制艙門）           │                       │
│   │  標籤:「舱门」                      │                       │
│   │                                     │                       │
│   └─────────────────────────────────────┘                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 確認結論

| 項目 | 確認結果 |
|------|---------|
| **2.4G 模組** | EBYTE E01 系列 |
| **核心晶片** | Nordic nRF24L01P |
| **協議類型** | 私有協議（非 Zigbee、非 BLE） |
| **PCB 設計** | YOGO Robot 自製載板 |

---

## EBYTE E01 模組規格

### 基本資訊

| 項目 | 規格 |
|------|------|
| **廠商** | EBYTE（億佰特，中國成都） |
| **型號** | E01 系列（E01-2G4M27D / E01-ML01SP4 等） |
| **核心晶片** | Nordic nRF24L01P |
| **頻率範圍** | 2.4 ~ 2.525 GHz |
| **介面** | SPI |
| **傳輸功率** | 13~27 dBm（視型號） |
| **通訊距離** | 800m ~ 5km（視型號和環境） |
| **資料速率** | 250Kbps / 1Mbps / 2Mbps（可調） |
| **工作電壓** | 2.0V ~ 3.6V |
| **工作溫度** | -40°C ~ +85°C |
| **價格** | ~$3-5 USD |

### 模組特點

```
┌─────────────────────────────────────────────────────────────────┐
│  EBYTE E01 系列特點                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ✅ 基於 Nordic 原廠 nRF24L01P 晶片（非國產仿製）                │
│  ✅ 內建 PA（功率放大器）+ LNA（低噪聲放大器）                   │
│  ✅ 金屬屏蔽罩，抗干擾能力強                                     │
│  ✅ 工業級設計，通過 CE 認證                                     │
│  ✅ SPI 介面，與 MCU 連接簡單                                    │
│  ✅ 125 個通訊頻道，支援多點通訊和跳頻                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### nRF24L01P 晶片特性

| 特性 | 說明 |
|------|------|
| **封包格式** | 1~32 bytes payload，3 個 FIFO buffer |
| **位址長度** | 3~5 bytes（可配置） |
| **CRC** | 1 或 2 bytes |
| **自動應答** | Enhanced ShockBurst™ 協議 |
| **自動重傳** | 可配置重傳次數和延遲 |

---

## 系統中 2.4G 的角色

### 雙層通訊架構

```
              雲平台 (Aurotek Cloud)
        ┌─────────────────────────────────┐
        │  app-delivery    jarvis-iot-v6  │
        └───────────────┬─────────────────┘
                        │
                        │ 4G gRPC :443
                        │ （雲端調度層）
                        │
         ┌──────────────┴──────────────┐
         │                             │
    ┌─────────┐                   ┌─────────┐
    │ Station │◄─────────────────►│  Robot  │
    │         │                   │         │
    │ EBYTE   │    2.4G 無線      │ EBYTE   │
    │ E01     │  （本地協作層）    │ E01     │
    └─────────┘                   └─────────┘
```

### 各層職責

| 通訊層 | 協議 | 用途 | 延遲要求 |
|--------|------|------|---------|
| **雲端調度層** | 4G gRPC | 任務分配、狀態同步、事件上報 | 可容忍 50-200ms |
| **本地協作層** | 2.4G nRF24L01P | 握手驗證、艙門控制、即時協作 | 必須 <10ms |

---

## 為什麼需要 2.4G

### 場景：Robot 進入 Station 艙門

```
┌─────────────────────────────────────────────────────────────────┐
│  如果只用 4G：                                                   │
│                                                                 │
│    Robot ──► 4G ──► 雲平台 ──► 4G ──► Station                   │
│                                                                 │
│    延遲：50~200ms（網路不穩可能更久）                             │
│    問題：艙門開關需要即時反應，延遲會導致碰撞                      │
├─────────────────────────────────────────────────────────────────┤
│  用 2.4G（nRF24L01P）：                                          │
│                                                                 │
│    Robot ◄──► 2.4G ◄──► Station                                 │
│                                                                 │
│    延遲：<5ms（nRF24L01P 特性）                                  │
│    優點：本地直接通訊，不依賴網路                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 實驗證據

**2025-10-28 16:32-16:36 實驗**：
- 拔除 2.4G 電源後，Robot 無法進入 Station
- Station 出現 `process_unit_event` 錯誤
- 系統自動切換策略，後續任務直接分配給 Robot

**結論**：2.4G 是不可替代的關鍵組件，斷線會導致 Station-Robot 本地協作失敗。

---

## 業界常見 2.4G 方案

| 協議 | 常見模組 | 特點 | 適用場景 |
|------|---------|------|---------|
| **私有 2.4G** ⭐ | Nordic nRF24L01、nRF52840 | 超低延遲（<5ms）、自訂協議 | 機器人協作、即時控制 |
| **Zigbee** | TI CC2530/CC2652、Silicon Labs EFR32 | 低功耗、mesh 組網、延遲約 15ms | 智慧工廠、感測器網路 |
| **藍牙 BLE** | TI CC2640、Nordic nRF52 | 普及、低功耗 | 短距離、簡單配對 |
| **WiFi** | ESP32、Realtek RTL8720 | 高頻寬、普及 | 數據量大、非即時 |
| **Thread** | Nordic nRF52840、Silicon Labs | IPv6、mesh、新標準 | 智慧家居、新專案 |

⭐ **YOGO Robot 使用的是「私有 2.4G」方案（已確認）**

### 各方案比較

```
延遲      低 ◄─────────────────────────────────► 高
          │                                      │
    私有 2.4G    Zigbee      BLE      Thread    WiFi
     <5ms        ~15ms      ~30ms     ~50ms    ~100ms
       ▲
       │
   YOGO 選擇
```

---

## 2.4G 通訊協議分析

### 消息結構（從 Log 推測）

```
┌─────────────────────────────────────────────────────────────────┐
│                     2.4G 消息結構                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   AirMessageHeader (消息頭)                                      │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ message_type: int    # 消息類型 (34/35/37/38)           │   │
│   │ unit_sid: int        # 設備 ID ← 用這個識別對方          │   │
│   │ version: int         # 消息版本號                        │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   SAirSay (空中消息)                                             │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ msg_type: AIR_SAY_MESSAGE_TYPE   # 消息類型枚舉          │   │
│   │ say: str                          # Base64 編碼的消息    │   │
│   │ created_at: int                   # Unix 時間戳 (毫秒)   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   ※ 底層使用 nRF24L01P Enhanced ShockBurst™ 封包格式           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 消息類型

| 類型 | 枚舉值 | 用途 |
|-----|-------|------|
| `PASS_DOOR_ROBOT_SAY` | 34 | 過門狀態（進入/離開 Station） |
| `STATION_ROBOT_SAY` | 35 | Station-Robot 通訊 |
| `CHARGE_ROBOT_SAY` | 37 | 充電狀態 |
| `PLANNING_ROBOT_SAY` | 38 | 規劃狀態 |

### 2.4G 握手流程

```
    Station (EBYTE E01)                      Robot (EBYTE E01)
       │                                               │
       │  1. Station 廣播 2.4G 信號                     │
       │   (包含 Station 的 unit_sid)                  │
       │──────────────────────────────────────────────►│
       │                                               │
       │  2. Robot 發送認證請求                         │
       │   message_type: STATION_ROBOT_SAY (35)        │
       │   unit_sid: Robot_ID (如 1010020021)          │
       │◄──────────────────────────────────────────────│
       │                                               │
       │  3. Station 驗證 Robot 身份                    │
       │   - 檢查 unit_sid 是否在授權列表               │
       │                                               │
       │  4. 驗證通過，發送確認                         │
       │   message_type: STATION_ROBOT_SAY (35)        │
       │   unit_sid: Station_ID (如 1020025026)        │
       │──────────────────────────────────────────────►│
       │                                               │
       │  5. 開啟艙門，Robot 進入                       │
       │◄─────────────── 2.4G 連線建立 ────────────────►│
       │                                               │
```

### 實際 Log 證據

```python
air_says=[
    SAirSay(msg_type=CHARGE_ROBOT_SAY, say='JQogDzwA', created_at=1761637348870),
    SAirSay(msg_type=STATION_ROBOT_SAY, say='IwqAMwEQ8GRg...', created_at=1761637422474),
    SAirSay(msg_type=PASS_DOOR_ROBOT_SAY, say='IgowYwEQ...', created_at=1761629219582),
    SAirSay(msg_type=PLANNING_ROBOT_SAY, say='JgqAagAAAA...', created_at=1761637422450)
]
```

### 2.4G 數據上報機制

2.4G 通訊內容會透過 4G 間接上報到雲平台：

```
┌─────────────────────────────────────────────────────────────────┐
│                          現場 (Local)                           │
│                                                                 │
│   ┌──────────┐     2.4G 無線     ┌──────────┐                  │
│   │ Station  │◄─────────────────►│  Robot   │                  │
│   │ (E01)    │   (nRF24L01P)     │ (E01)    │                  │
│   └──────────┘                   └────┬─────┘                  │
│                                       │                        │
└───────────────────────────────────────┼────────────────────────┘
                                        │ 4G (SyncMeteorEvents)
                                        │ 打包上報 air_says
                                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                          雲平台 (Cloud)                          │
│                                                                 │
│   app-delivery-actor-robot 接收並處理 air_says (Base64 解碼)     │
└─────────────────────────────────────────────────────────────────┘
```

| 項目 | 說明 |
|-----|------|
| 2.4G 原始封包 | 不會直接傳到雲平台 |
| air_says 消息內容 | ✅ 會傳到雲平台 (Base64 編碼) |
| nearfield_status | ✅ 會傳到雲平台 (True/False) |
| 上報機制 | Robot 透過 4G SyncMeteorEvents 打包上報 |
| 上報頻率 | 每 1-5 秒 (隨心跳一起) |

---

## 自研 Station 的路線選擇

### 路線 A：逆向原廠協議（推薦短期）

```
┌─────────────────────────────────────────────────────────────────┐
│  優點                                                           │
│  • 自研 Station 可直接與現有 Robot 配合                          │
│  • 不需要改 Robot 韌體                                           │
│  • 硬體已確認，可直接購買 EBYTE E01 模組                         │
├─────────────────────────────────────────────────────────────────┤
│  缺點                                                           │
│  • 需要逆向工程 YOGO 的私有協議                                  │
│  • 可能有加密或校驗機制                                          │
│  • 沒有原廠文件，維護困難                                        │
├─────────────────────────────────────────────────────────────────┤
│  需要的資源                                                      │
│  • Station/Robot 設備端 Log（取得 2.4G 原始數據）                │
│  • nRF24L01P sniffer 抓取空中封包                               │
│  • Base64 內容解碼分析                                           │
│  • EBYTE E01 開發板測試                                          │
└─────────────────────────────────────────────────────────────────┘
```

### 路線 B：重新設計協議（長期選項）

```
┌─────────────────────────────────────────────────────────────────┐
│  優點                                                           │
│  • 完全掌控協議                                                  │
│  • 可以設計更好的安全機制                                        │
│  • 長期維護容易                                                  │
├─────────────────────────────────────────────────────────────────┤
│  缺點                                                           │
│  • 需要改 Robot 的 2.4G 韌體                                     │
│  • 工程量大                                                      │
│  • 過渡期複雜（新舊設備並存）                                     │
├─────────────────────────────────────────────────────────────────┤
│  需要的資源                                                      │
│  • Robot 韌體開發能力                                            │
│  • EBYTE E01 驅動開發                                            │
│  • 協議設計（可參考 nRF24L01P Enhanced ShockBurst）              │
└─────────────────────────────────────────────────────────────────┘
```

### 建議策略

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  短期（驗證階段）：走路線 A                                       │
│  ─────────────────────────                                      │
│  1. 購買 EBYTE E01 開發板                                        │
│  2. 取得設備端 Log，分析 2.4G 封包格式                           │
│  3. 用 nRF24L01P sniffer 抓取空中封包                           │
│  4. 逆向協議，用模擬器驗證                                       │
│                                                                 │
│  長期（量產階段）：評估路線 B                                     │
│  ─────────────────────────                                      │
│  如果逆向太困難或有安全疑慮                                       │
│  考慮重新設計協議                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 類似架構的商用案例

### 1. Amazon 倉儲機器人（Kiva/Amazon Robotics）

| 項目 | Amazon Robotics | Aurotek/YOGO 雲平台 |
|-----|-----------------|---------------------|
| 雲端調度 | ✅ 中央控制系統 | ✅ K8s + DAPR |
| 狀態管理 | ✅ 分散式狀態機 | ✅ Actor 模式 |
| 本地協作 | ✅ WiFi/專用無線 | ✅ 2.4G nRF24L01P |
| 規模 | 數千台 | 100+ 台 |

### 2. 菜鳥物流機器人（阿里巴巴）

- 無人倉儲 + 配送機器人
- 阿里雲 IoT 平台調度
- 多層通訊架構（雲端 + 邊緣 + 本地）

### 3. Uber/Lyft 車輛調度

| 項目 | Uber | Aurotek/YOGO 雲平台 |
|-----|------|---------------------|
| 實體單位 | 司機/車輛 | Robot/Station |
| 事件匯流 | Kafka | DAPR Pubsub |
| 狀態管理 | Ringpop (Actor-like) | DAPR Actor |
| 位置追蹤 | 4G + GPS | 4G gRPC |

---

## 目前已知 vs 未知

| 已知 ✅ | 未知 ❓ |
|--------|--------|
| 4G gRPC 協議（已逆向成功） | 2.4G 協議細節（YOGO 私有） |
| **2.4G 硬體模組 = EBYTE E01** | Base64 內容解碼方式 |
| **核心晶片 = Nordic nRF24L01P** | 加密/認證機制 |
| 消息類型（34, 35, 37, 38） | Station 設備端 Log |
| unit_sid 識別機制 | Robot 端 2.4G 模組型號（待確認） |
| 握手流程（從 Log 推測） | 完整封包格式 |
| 雲端上報機制 | |

---

## 下一步行動

| 優先級 | 行動項目 | 狀態 | 備註 |
|--------|---------|------|------|
| ✅ 完成 | 確認 Station 2.4G 晶片型號 | **已完成** | EBYTE E01 (nRF24L01P) |
| 🔴 高 | 確認 Robot 端 2.4G 模組型號 | 待執行 | 預期也是 E01 |
| 🔴 高 | 取得 Station/Robot 設備端 Log | 待執行 | 需要現場支援 |
| 🟡 中 | 購買 EBYTE E01 開發板 | 待執行 | 約 $5-10 USD |
| 🟡 中 | 分析 air_says Base64 內容 | 待執行 | 解碼封包結構 |
| 🟡 中 | 用 nRF24L01P sniffer 抓封包 | 待執行 | 需要專用硬體 |
| 🟢 低 | 評估重新設計協議的可行性 | 待評估 | 長期規劃 |

---

## 相關資源

### EBYTE E01 購買連結

- [EBYTE 官方商城](https://www.cdebyte.com/Module-SPISOCUART-nRF24)
- [淘寶/天貓](https://www.taobao.com) 搜尋「EBYTE E01」
- [RobotShop](https://www.robotshop.com) 搜尋「EBYTE E01」

### 技術文檔

- [EBYTE E01 Datasheet](https://www.cdebyte.com/Product-Selection)
- [Nordic nRF24L01P Datasheet](https://www.nordicsemi.com/Products/nRF24-series)

### 相關文檔

- [雲平台-Station-Robot 通信閉環時序說明](./08-communication-loop-sequence.md)
- [DAPR 與 Actor 模式分析](./07-dapr-actor-analysis.md)
- [系統架構總覽](./01-system-architecture-overview.md)

---

## 更新記錄

| 版本 | 日期 | 更新內容 |
|------|------|---------|
| v1.0 | 2025-12-08 | 初版，推測硬體方案 |
| v2.0 | 2025-12-08 | **確認硬體為 EBYTE E01 (nRF24L01P)**，新增模組規格 |

---

**文檔維護**: 本文檔應隨 2.4G 協議分析進展持續更新。
