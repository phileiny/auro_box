# 2.4G 通訊模組分析

**文檔版本**: v1.0  
**最後更新**: 2025-12-08  
**狀態**: 📋 待驗證

---

## 目錄

1. [系統中 2.4G 的角色](#系統中-24g-的角色)
2. [為什麼需要 2.4G](#為什麼需要-24g)
3. [業界常見 2.4G 方案](#業界常見-24g-方案)
4. [原廠可能使用的方案](#原廠可能使用的方案)
5. [2.4G 通訊協議分析](#24g-通訊協議分析)
6. [如何確認原廠方案](#如何確認原廠方案)
7. [自研 Station 的路線選擇](#自研-station-的路線選擇)
8. [類似架構的商用案例](#類似架構的商用案例)

---

## 系統中 2.4G 的角色

### 雙層通訊架構

```
              雲平台 (Aurotek Cloud)
        ┌─────────────────────────────────┐
        │  app-delivery    jarvis-iot-v6  │
        └───────────────┬─────────────────┘
                        │
                        │ 4G gRPC :443
                        │ （雲端調度層）
                        │
         ┌──────────────┴──────────────┐
         │                             │
    ┌─────────┐                   ┌─────────┐
    │ Station │◄─────────────────►│  Robot  │
    └─────────┘                   └─────────┘
                    2.4G 無線
                 （本地協作層）
```

### 各層職責

| 通訊層 | 協議 | 用途 | 延遲要求 |
|--------|------|------|---------|
| **雲端調度層** | 4G gRPC | 任務分配、狀態同步、事件上報 | 可容忍 50-200ms |
| **本地協作層** | 2.4G 無線 | 握手驗證、艙門控制、即時協作 | 必須 <10ms |

---

## 為什麼需要 2.4G

### 場景：Robot 進入 Station 艙門

```
┌─────────────────────────────────────────────────────────────────┐
│  如果只用 4G：                                                   │
│                                                                 │
│    Robot ──► 4G ──► 雲平台 ──► 4G ──► Station                   │
│                                                                 │
│    延遲：50~200ms（網路不穩可能更久）                             │
│    問題：艙門開關需要即時反應，延遲會導致碰撞                      │
├─────────────────────────────────────────────────────────────────┤
│  用 2.4G：                                                       │
│                                                                 │
│    Robot ◄──► 2.4G ◄──► Station                                 │
│                                                                 │
│    延遲：<10ms                                                   │
│    優點：本地直接通訊，不依賴網路                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 實驗證據

**2025-10-28 16:32-16:36 實驗**：
- 拔除 2.4G 電源後，Robot 無法進入 Station
- Station 出現 `process_unit_event` 錯誤
- 系統自動切換策略，後續任務直接分配給 Robot

**結論**：2.4G 是不可替代的關鍵組件，斷線會導致 Station-Robot 本地協作失敗。

---

## 業界常見 2.4G 方案

| 協議 | 常見模組 | 特點 | 適用場景 |
|------|---------|------|---------|
| **私有 2.4G** | Nordic nRF24L01、nRF52840 | 超低延遲（<5ms）、自訂協議 | 機器人協作、即時控制 |
| **Zigbee** | TI CC2530/CC2652、Silicon Labs EFR32 | 低功耗、mesh 組網、延遲約 15ms | 智慧工廠、感測器網路 |
| **藍牙 BLE** | TI CC2640、Nordic nRF52 | 普及、低功耗 | 短距離、簡單配對 |
| **WiFi** | ESP32、Realtek RTL8720 | 高頻寬、普及 | 數據量大、非即時 |
| **Thread** | Nordic nRF52840、Silicon Labs | IPv6、mesh、新標準 | 智慧家居、新專案 |

### 各方案比較

```
延遲      低 ◄─────────────────────────────────► 高
          │                                      │
    私有 2.4G    Zigbee      BLE      Thread    WiFi
     <5ms        ~15ms      ~30ms     ~50ms    ~100ms
          │                                      │
頻寬      低 ◄─────────────────────────────────► 高
```

---

## 原廠可能使用的方案

### 最可能：私有 2.4G（Nordic nRF24L01 / nRF52840）

**推測依據**：

1. **延遲要求**：艙門控制需要 <10ms，只有私有 2.4G 能達到
2. **協議格式**：Log 顯示 Base64 編碼的私有格式（非標準協議）
3. **識別機制**：`unit_sid` 是自訂的識別方式
4. **消息類型**：34、35、37、38 是私有定義的枚舉

```
┌─────────────────────────────────────────────────────────────────┐
│  Nordic nRF24L01 / nRF52840                                     │
├─────────────────────────────────────────────────────────────────┤
│  • 延遲：<5ms（符合艙門控制需求）                                 │
│  • 原廠自訂協議（所以沒有公開文件）                               │
│  • 成本低：模組約 $1-3 USD                                       │
│  • 缺點：協議私有，逆向工程困難                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 其他可能：Zigbee

```
┌─────────────────────────────────────────────────────────────────┐
│  TI CC2530 / CC2652                                             │
├─────────────────────────────────────────────────────────────────┤
│  • 工業級常用                                                    │
│  • 支援 mesh 組網（多 Station 互連）                             │
│  • 有標準協議，但可以自訂 Application Layer                      │
│  • 延遲約 15-30ms                                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2.4G 通訊協議分析

### 消息結構（從 Log 推測）

```
┌─────────────────────────────────────────────────────────────────┐
│                     2.4G 消息結構                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   AirMessageHeader (消息頭)                                      │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ message_type: int    # 消息類型 (34/35/37/38)           │   │
│   │ unit_sid: int        # 設備 ID ← 用這個識別對方          │   │
│   │ version: int         # 消息版本號                        │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   SAirSay (空中消息)                                             │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ msg_type: AIR_SAY_MESSAGE_TYPE   # 消息類型枚舉          │   │
│   │ say: str                          # Base64 編碼的消息    │   │
│   │ created_at: int                   # Unix 時間戳 (毫秒)   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 消息類型

| 類型 | 枚舉值 | 用途 |
|-----|-------|------|
| `PASS_DOOR_ROBOT_SAY` | 34 | 過門狀態（進入/離開 Station） |
| `STATION_ROBOT_SAY` | 35 | Station-Robot 通訊 |
| `CHARGE_ROBOT_SAY` | 37 | 充電狀態 |
| `PLANNING_ROBOT_SAY` | 38 | 規劃狀態 |

### 2.4G 握手流程

```
    Station                                          Robot
       │                                               │
       │  1. Station 廣播 2.4G 信號                     │
       │   (包含 Station 的 unit_sid)                  │
       │──────────────────────────────────────────────►│
       │                                               │
       │  2. Robot 發送認證請求                         │
       │   message_type: STATION_ROBOT_SAY (35)        │
       │   unit_sid: Robot_ID (如 1010020021)          │
       │◄──────────────────────────────────────────────│
       │                                               │
       │  3. Station 驗證 Robot 身份                    │
       │   - 檢查 unit_sid 是否在授權列表               │
       │                                               │
       │  4. 驗證通過，發送確認                         │
       │   message_type: STATION_ROBOT_SAY (35)        │
       │   unit_sid: Station_ID (如 1020025026)        │
       │──────────────────────────────────────────────►│
       │                                               │
       │  5. 開啟艙門，Robot 進入                       │
       │◄─────────────── 2.4G 連線建立 ────────────────►│
       │                                               │
```

### 實際 Log 證據

```python
air_says=[
    SAirSay(msg_type=CHARGE_ROBOT_SAY, say='JQogDzwA', created_at=1761637348870),
    SAirSay(msg_type=STATION_ROBOT_SAY, say='IwqAMwEQ8GRg...', created_at=1761637422474),
    SAirSay(msg_type=PASS_DOOR_ROBOT_SAY, say='IgowYwEQ...', created_at=1761629219582),
    SAirSay(msg_type=PLANNING_ROBOT_SAY, say='JgqAagAAAA...', created_at=1761637422450)
]
```

### 2.4G 數據上報機制

2.4G 通訊內容會透過 4G 間接上報到雲平台：

```
┌─────────────────────────────────────────────────────────────────┐
│                          現場 (Local)                           │
│                                                                 │
│   ┌──────────┐     2.4G 無線     ┌──────────┐                  │
│   │ Station  │◄─────────────────►│  Robot   │                  │
│   │          │   (直接通訊)       │          │                  │
│   └──────────┘                   └────┬─────┘                  │
│                                       │                        │
└───────────────────────────────────────┼────────────────────────┘
                                        │ 4G (SyncMeteorEvents)
                                        │ 打包上報 air_says
                                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                          雲平台 (Cloud)                          │
│                                                                 │
│   app-delivery-actor-robot 接收並處理 air_says (Base64 解碼)     │
└─────────────────────────────────────────────────────────────────┘
```

| 項目 | 說明 |
|-----|------|
| 2.4G 原始封包 | 不會直接傳到雲平台 |
| air_says 消息內容 | ✅ 會傳到雲平台 (Base64 編碼) |
| nearfield_status | ✅ 會傳到雲平台 (True/False) |
| 上報機制 | Robot 透過 4G SyncMeteorEvents 打包上報 |
| 上報頻率 | 每 1-5 秒 (隨心跳一起) |

---

## 如何確認原廠方案

| 方法 | 難度 | 說明 |
|------|------|------|
| **1. 看硬體** | ⭐ | 打開 Station/Robot，看 2.4G 模組上的晶片型號 |
| **2. 問原廠** | ⭐ | 直接問，但他們可能不願意說 |
| **3. 頻譜分析** | ⭐⭐⭐ | 用 SDR（軟體定義無線電）掃描頻譜特徵 |
| **4. 抓封包** | ⭐⭐⭐ | 用 Zigbee sniffer 或通用 2.4G sniffer |

### 建議步驟

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 打開設備看晶片                                          │
│  ────────────────────                                           │
│  找到 2.4G 模組，記錄晶片型號                                     │
│  常見型號：nRF24L01、CC2530、CC2652、nRF52840                    │
├─────────────────────────────────────────────────────────────────┤
│  Step 2: 查詢晶片規格                                            │
│  ────────────────────                                           │
│  根據晶片型號確認支援的協議                                       │
│  • nRF24L01 → 私有 2.4G                                         │
│  • CC2530/CC2652 → Zigbee                                       │
│  • nRF52840 → 私有 2.4G / BLE / Thread                          │
├─────────────────────────────────────────────────────────────────┤
│  Step 3: 取得設備端 Log                                          │
│  ────────────────────                                           │
│  分析 Station/Robot 的本地 Log                                   │
│  確認 2.4G 通訊的實際內容和格式                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 自研 Station 的路線選擇

### 路線 A：逆向原廠協議

```
┌─────────────────────────────────────────────────────────────────┐
│  優點                                                           │
│  • 自研 Station 可直接與現有 Robot 配合                          │
│  • 不需要改 Robot 韌體                                           │
├─────────────────────────────────────────────────────────────────┤
│  缺點                                                           │
│  • 需要逆向工程（可能有加密）                                     │
│  • 沒有原廠文件，維護困難                                        │
├─────────────────────────────────────────────────────────────────┤
│  需要的資源                                                      │
│  • Station/Robot 設備端 Log（你正在取得的）                      │
│  • 2.4G sniffer 抓封包                                          │
│  • Base64 內容解碼分析                                           │
└─────────────────────────────────────────────────────────────────┘
```

### 路線 B：重新設計協議

```
┌─────────────────────────────────────────────────────────────────┐
│  優點                                                           │
│  • 完全掌控協議                                                  │
│  • 可以設計更好的安全機制                                        │
│  • 長期維護容易                                                  │
├─────────────────────────────────────────────────────────────────┤
│  缺點                                                           │
│  • 需要改 Robot 的 2.4G 韌體                                     │
│  • 工程量大                                                      │
│  • 過渡期複雜（新舊設備並存）                                     │
├─────────────────────────────────────────────────────────────────┤
│  需要的資源                                                      │
│  • Robot 韌體開發能力                                            │
│  • 2.4G 模組選型和驅動開發                                       │
│  • 協議設計                                                      │
└─────────────────────────────────────────────────────────────────┘
```

### 建議

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  短期（驗證階段）：走路線 A                                       │
│  ─────────────────────────                                      │
│  先取得設備端 Log，嘗試逆向 2.4G 協議                             │
│  用模擬器驗證理解是否正確                                         │
│                                                                 │
│  長期（量產階段）：評估路線 B                                     │
│  ─────────────────────────                                      │
│  如果逆向太困難或有安全疑慮                                       │
│  考慮重新設計協議                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 類似架構的商用案例

### 1. Amazon 倉儲機器人（Kiva/Amazon Robotics）

| 項目 | Amazon Robotics | Aurotek 雲平台 |
|-----|-----------------|---------------|
| 雲端調度 | ✅ 中央控制系統 | ✅ K8s + DAPR |
| 狀態管理 | ✅ 分散式狀態機 | ✅ Actor 模式 |
| 本地協作 | ✅ WiFi/專用無線 | ✅ 2.4G 無線 |
| 規模 | 數千台 | 100+ 台 |

### 2. 菜鳥物流機器人（阿里巴巴）

- 無人倉儲 + 配送機器人
- 阿里雲 IoT 平台調度
- 多層通訊架構（雲端 + 邊緣 + 本地）

### 3. Uber/Lyft 車輛調度

| 項目 | Uber | Aurotek 雲平台 |
|-----|------|---------------|
| 實體單位 | 司機/車輛 | Robot/Station |
| 事件匯流 | Kafka | DAPR Pubsub |
| 狀態管理 | Ringpop (Actor-like) | DAPR Actor |
| 位置追蹤 | 4G + GPS | 4G gRPC |

---

## 目前已知 vs 未知

| 已知 | 未知 |
|------|------|
| ✅ 4G gRPC 協議（已逆向成功） | ❌ 2.4G 硬體模組型號 |
| ✅ 消息類型（34, 35, 37, 38） | ❌ 2.4G 協議細節 |
| ✅ unit_sid 識別機制 | ❌ Base64 內容解碼方式 |
| ✅ 握手流程（從 Log 推測） | ❌ 加密/認證機制 |
| ✅ 雲端上報機制 | ❌ Station 設備端 Log |

---

## 下一步行動

| 優先級 | 行動項目 | 負責人 | 預計時間 |
|--------|---------|--------|---------|
| 🔴 高 | 取得 Station/Robot 設備端 Log | - | - |
| 🔴 高 | 打開設備確認 2.4G 晶片型號 | - | - |
| 🟡 中 | 分析 air_says Base64 內容 | - | - |
| 🟡 中 | 用 sniffer 抓取 2.4G 封包 | - | - |
| 🟢 低 | 評估重新設計協議的可行性 | - | - |

---

## 相關文檔

- [雲平台-Station-Robot 通信閉環時序說明](./08-communication-loop-sequence.md)
- [DAPR 與 Actor 模式分析](./07-dapr-actor-analysis.md)
- [系統架構總覽](./01-system-architecture-overview.md)

---

**文檔維護**: 本文檔應隨 2.4G 協議分析進展持續更新。
