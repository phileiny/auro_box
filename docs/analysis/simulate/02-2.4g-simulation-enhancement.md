# 2.4G æœ¬åœ°é€šè¨Šæ¨¡æ“¬å¢å¼·æ–¹æ¡ˆ

**æ–‡æª”ç‰ˆæœ¬**: v1.0
**å‰µå»ºæ™‚é–“**: 2025-12-02
**åŸºæ–¼**: `clue/*1542.md` å¯¦éš› log åˆ†æ
**ç‹€æ…‹**: ğŸ“‹ è¦åŠƒä¸­

---

## èƒŒæ™¯

åŸå§‹ `00-implementation-plan.md` ä½¿ç”¨ç°¡åŒ–çš„ Queue/Event æ¨¡æ“¬ 2.4G é€šè¨Šã€‚
æ ¹æ“šå¯¦éš› log åˆ†æï¼Œç™¼ç¾ 2.4G é€šè¨Šæ•¸æ“šæœƒé€é Robot 4G ä¸Šå ±å‚³åˆ°é›²å¹³å°ã€‚
ç‚ºäº†æ›´çœŸå¯¦åœ°æ¨¡æ“¬ï¼Œéœ€è¦å¢å¼· 2.4G æ¨¡æ“¬æ¨¡çµ„ã€‚

---

## å¯¦éš› 2.4G æ•¸æ“šçµæ§‹ (å¾ Log æå–)

### 1. SAirSay æ¶ˆæ¯çµæ§‹

```python
from enum import IntEnum
from dataclasses import dataclass
from typing import List
import base64
import struct
import time

class AIR_SAY_MESSAGE_TYPE(IntEnum):
    """2.4G ç©ºä¸­æ¶ˆæ¯é¡å‹"""
    PASS_DOOR_ROBOT_SAY = 34    # éé–€ç‹€æ…‹
    STATION_ROBOT_SAY = 35      # Station-Robot é€šè¨Š
    CHARGE_ROBOT_SAY = 37       # å……é›»ç‹€æ…‹
    PLANNING_ROBOT_SAY = 38     # è¦åŠƒç‹€æ…‹


@dataclass
class SAirSay:
    """2.4G ç©ºä¸­æ¶ˆæ¯"""
    msg_type: AIR_SAY_MESSAGE_TYPE
    say: str                     # Base64 ç·¨ç¢¼çš„æ¶ˆæ¯å…§å®¹
    created_at: int              # Unix timestamp (æ¯«ç§’)

    @classmethod
    def create(cls, msg_type: AIR_SAY_MESSAGE_TYPE, payload: bytes) -> 'SAirSay':
        """å‰µå»ºæ¶ˆæ¯"""
        return cls(
            msg_type=msg_type,
            say=base64.b64encode(payload).decode('utf-8'),
            created_at=int(time.time() * 1000)
        )
```

### 2. PassDoorRobotAirSay çµæ§‹

```python
@dataclass
class Position:
    """ä½ç½®è³‡è¨Š"""
    map_sid: int
    zone_id: int
    x: int
    y: int
    theta: int


class PassDoorPosition(IntEnum):
    """éé–€ä½ç½®ç‹€æ…‹"""
    Unknown = 0
    Outside = 1
    Inside = 2
    Passing = 3


@dataclass
class UnitStatus:
    """è¨­å‚™ç‹€æ…‹"""
    unit_enabled: bool
    cellular_status: bool        # 4G é€£ç·šç‹€æ…‹
    nearfield_status: bool       # 2.4G è¿‘å ´é€šè¨Šç‹€æ…‹


@dataclass
class AirMessageHeader:
    """ç©ºä¸­æ¶ˆæ¯é ­"""
    message_type: int
    unit_sid: int
    version: int


@dataclass
class PassDoorRobotSay:
    """éé–€ Robot ç‹€æ…‹"""
    position: Position
    velocity: int
    angular_velocity: int
    destination_poi_sid: int
    pass_door_position: PassDoorPosition
    unit_status: UnitStatus
    # ... æ›´å¤šæ¬„ä½


@dataclass
class PassDoorRobotAirSay:
    """å®Œæ•´çš„éé–€ç©ºä¸­æ¶ˆæ¯"""
    header: AirMessageHeader
    say: PassDoorRobotSay
```

### 3. Robot å¿ƒè·³æ•¸æ“š (åŒ…å« air_says)

```python
@dataclass
class RobotHeartbeat:
    """Robot å¿ƒè·³"""
    task_uuid: bytes
    space_state: int             # INSIDE_STATION=310, PLAIN=200
    purpose_state: int           # WAITING_STATION=60, GO_POINT=30
    mission_type: int            # STANDBY=1, GO_POINT=2
    battery_soc: int             # é›»é‡ç™¾åˆ†æ¯”
    is_charging: bool
    destination_poi_sid: int
    # ... æ›´å¤šæ¬„ä½


@dataclass
class RobotPingData:
    """Robot ping ä¸Šå ±æ•¸æ“š"""
    robot_say: PassDoorRobotAirSay
    air_says: List[SAirSay]      # 2.4G æ¶ˆæ¯åˆ—è¡¨
    heartbeat: RobotHeartbeat
    nearfield_status: bool       # 2.4G é€£ç·šç‹€æ…‹
```

---

## å¢å¼·çš„ 2.4G æ¨¡æ“¬æ¨¡çµ„

### 1. 2.4G æ¶ˆæ¯ç”Ÿæˆå™¨ (`common/air_say_generator.py`)

```python
class AirSayGenerator:
    """2.4G ç©ºä¸­æ¶ˆæ¯ç”Ÿæˆå™¨"""

    def __init__(self, unit_sid: int):
        self.unit_sid = unit_sid
        self.version = 0

    def generate_station_robot_say(self,
                                   position: Position,
                                   destination_poi: int) -> SAirSay:
        """ç”Ÿæˆ Station-Robot é€šè¨Šæ¶ˆæ¯"""
        self.version += 1

        # ç·¨ç¢¼æ¶ˆæ¯å…§å®¹
        payload = self._encode_station_robot_say(
            position, destination_poi, self.version
        )

        return SAirSay.create(
            msg_type=AIR_SAY_MESSAGE_TYPE.STATION_ROBOT_SAY,
            payload=payload
        )

    def generate_pass_door_robot_say(self,
                                     position: Position,
                                     pass_door_position: PassDoorPosition,
                                     nearfield_status: bool) -> SAirSay:
        """ç”Ÿæˆéé–€ç‹€æ…‹æ¶ˆæ¯"""
        self.version += 1

        payload = self._encode_pass_door_robot_say(
            position, pass_door_position, nearfield_status, self.version
        )

        return SAirSay.create(
            msg_type=AIR_SAY_MESSAGE_TYPE.PASS_DOOR_ROBOT_SAY,
            payload=payload
        )

    def generate_charge_robot_say(self,
                                  battery_soc: int,
                                  is_charging: bool) -> SAirSay:
        """ç”Ÿæˆå……é›»ç‹€æ…‹æ¶ˆæ¯"""
        payload = self._encode_charge_robot_say(battery_soc, is_charging)

        return SAirSay.create(
            msg_type=AIR_SAY_MESSAGE_TYPE.CHARGE_ROBOT_SAY,
            payload=payload
        )

    def _encode_station_robot_say(self, position, destination_poi, version):
        """ç·¨ç¢¼ Station-Robot æ¶ˆæ¯ (æ¨¡æ“¬çœŸå¯¦æ ¼å¼)"""
        # ç°¡åŒ–ç·¨ç¢¼ï¼Œå¯¦éš›æ‡‰æŒ‰ç…§çœŸå¯¦å”è­°
        data = struct.pack(
            '<BHHHHHI',
            35,                      # message_type
            self.unit_sid,           # unit_sid
            version,                 # version
            position.x,
            position.y,
            position.theta,
            destination_poi
        )
        return data

    def _encode_pass_door_robot_say(self, position, pass_door_position,
                                     nearfield_status, version):
        """ç·¨ç¢¼éé–€æ¶ˆæ¯"""
        data = struct.pack(
            '<BHHHHHIBB',
            34,                      # message_type
            self.unit_sid,
            version,
            position.x,
            position.y,
            position.theta,
            pass_door_position.value,
            1 if nearfield_status else 0
        )
        return data

    def _encode_charge_robot_say(self, battery_soc, is_charging):
        """ç·¨ç¢¼å……é›»æ¶ˆæ¯"""
        data = struct.pack(
            '<BBB',
            37,                      # message_type
            battery_soc,
            1 if is_charging else 0
        )
        return data
```

### 2. å¢å¼·çš„æœ¬åœ°æ¶ˆæ¯ç¸½ç·š (`common/nearfield_bus.py`)

```python
from queue import Queue
from threading import Thread, Event
from typing import Callable, Dict, List
import time


class NearfieldBus:
    """
    æ¨¡æ“¬ 2.4G è¿‘å ´é€šè¨Šç¸½ç·š

    ç‰¹é»ï¼š
    1. æ¨¡æ“¬çœŸå¯¦çš„ 2.4G è¨Šæ¯äº¤æ›
    2. ç¶­è­· nearfield_status ç‹€æ…‹
    3. ç”Ÿæˆç¬¦åˆçœŸå¯¦æ ¼å¼çš„ air_says
    """

    def __init__(self):
        self.subscribers: Dict[str, List[Callable]] = {}
        self.message_queue = Queue()
        self.running = Event()

        # 2.4G ç‹€æ…‹
        self.nearfield_status = False
        self.connected_units: Dict[int, bool] = {}  # unit_sid -> connected

        # æ¶ˆæ¯ç”Ÿæˆå™¨
        self.air_say_generators: Dict[int, AirSayGenerator] = {}

        # æ¶ˆæ¯æ­·å² (ç”¨æ–¼ä¸Šå ±)
        self.air_says_buffer: Dict[int, List[SAirSay]] = {}

    def register_unit(self, unit_sid: int):
        """è¨»å†Šè¨­å‚™"""
        self.connected_units[unit_sid] = False
        self.air_say_generators[unit_sid] = AirSayGenerator(unit_sid)
        self.air_says_buffer[unit_sid] = []

    def connect_unit(self, unit_sid: int):
        """è¨­å‚™é€£ç·š (æ¨¡æ“¬ 2.4G æ¡æ‰‹æˆåŠŸ)"""
        self.connected_units[unit_sid] = True
        self.nearfield_status = True
        print(f"[2.4G] Unit {unit_sid} connected, nearfield_status=True")

    def disconnect_unit(self, unit_sid: int):
        """è¨­å‚™æ–·ç·š"""
        self.connected_units[unit_sid] = False
        # æª¢æŸ¥æ˜¯å¦é‚„æœ‰å…¶ä»–è¨­å‚™é€£ç·š
        self.nearfield_status = any(self.connected_units.values())
        print(f"[2.4G] Unit {unit_sid} disconnected, nearfield_status={self.nearfield_status}")

    def send_message(self,
                     from_unit: int,
                     to_unit: int,
                     msg_type: AIR_SAY_MESSAGE_TYPE,
                     payload: dict):
        """
        ç™¼é€ 2.4G æ¶ˆæ¯

        Args:
            from_unit: ç™¼é€æ–¹ unit_sid
            to_unit: æ¥æ”¶æ–¹ unit_sid
            msg_type: æ¶ˆæ¯é¡å‹
            payload: æ¶ˆæ¯å…§å®¹
        """
        if not self.connected_units.get(from_unit) or \
           not self.connected_units.get(to_unit):
            print(f"[2.4G] Message failed: units not connected")
            return False

        # ç”Ÿæˆ SAirSay
        generator = self.air_say_generators[from_unit]

        if msg_type == AIR_SAY_MESSAGE_TYPE.STATION_ROBOT_SAY:
            air_say = generator.generate_station_robot_say(
                payload['position'],
                payload['destination_poi']
            )
        elif msg_type == AIR_SAY_MESSAGE_TYPE.PASS_DOOR_ROBOT_SAY:
            air_say = generator.generate_pass_door_robot_say(
                payload['position'],
                payload['pass_door_position'],
                self.nearfield_status
            )
        else:
            # å…¶ä»–é¡å‹...
            air_say = SAirSay.create(msg_type, b'')

        # ç·©å­˜æ¶ˆæ¯ (ä¾› 4G ä¸Šå ±ä½¿ç”¨)
        self.air_says_buffer[from_unit].append(air_say)

        # ç™¼é€çµ¦è¨‚é–±è€…
        topic = f"unit.{to_unit}"
        if topic in self.subscribers:
            for callback in self.subscribers[topic]:
                callback(air_say, payload)

        return True

    def get_air_says_for_upload(self, unit_sid: int) -> List[SAirSay]:
        """
        ç²å–å¾…ä¸Šå ±çš„ air_says (ä¾› 4G å¿ƒè·³ä½¿ç”¨)

        Returns:
            List[SAirSay]: å¾…ä¸Šå ±çš„æ¶ˆæ¯åˆ—è¡¨
        """
        messages = self.air_says_buffer.get(unit_sid, [])
        # æ¸…ç©ºç·©å­˜ (å·²ä¸Šå ±)
        self.air_says_buffer[unit_sid] = []
        return messages

    def get_nearfield_status(self) -> bool:
        """ç²å– 2.4G é€£ç·šç‹€æ…‹"""
        return self.nearfield_status

    def subscribe(self, unit_sid: int, callback: Callable):
        """è¨‚é–±æ¶ˆæ¯"""
        topic = f"unit.{unit_sid}"
        if topic not in self.subscribers:
            self.subscribers[topic] = []
        self.subscribers[topic].append(callback)
```

### 3. å¢å¼·çš„ Robot æ¨¡æ“¬å™¨ (`robot/robot_simulator_v2.py`)

```python
class RobotSimulatorV2:
    """å¢å¼·ç‰ˆ Robot æ¨¡æ“¬å™¨ï¼Œæ”¯æ´çœŸå¯¦ 2.4G æ¶ˆæ¯æ ¼å¼"""

    def __init__(self, unit_sn: str, unit_sid: int):
        self.unit_sn = unit_sn
        self.unit_sid = unit_sid

        # gRPC å®¢æˆ¶ç«¯
        self.grpc_client = GrpcClient(GRPC_SERVER)

        # 2.4G è¿‘å ´é€šè¨Š
        self.nearfield_bus = NearfieldBus()
        self.nearfield_bus.register_unit(unit_sid)

        # ç‹€æ…‹
        self.position = Position(map_sid=1, zone_id=1, x=1615, y=1718, theta=1040)
        self.battery_soc = 59
        self.is_charging = False
        self.space_state = SPACE_STATE.PLAIN
        self.purpose_state = PURPOSE_STATE.IDLE

    async def start(self):
        """å•Ÿå‹• Robot"""
        # 1. 4G è¨»å†Šç™»å…¥
        await self.grpc_client.register_and_login(self.unit_sn)

        # 2. å•Ÿå‹• 4G å¿ƒè·³ (åŒ…å« air_says ä¸Šå ±)
        asyncio.create_task(self._heartbeat_loop())

        # 3. è¨‚é–± 2.4G æ¶ˆæ¯
        self.nearfield_bus.subscribe(self.unit_sid, self._on_air_say_received)

    async def enter_station(self, station_sid: int):
        """é€²å…¥ Station (è§¸ç™¼ 2.4G æ¡æ‰‹)"""
        # æ¨¡æ“¬ 2.4G æ¡æ‰‹
        self.nearfield_bus.connect_unit(self.unit_sid)

        # æ›´æ–°ç‹€æ…‹
        self.space_state = SPACE_STATE.INSIDE_STATION
        self.purpose_state = PURPOSE_STATE.WAITING_STATION

        # ç™¼é€éé–€æ¶ˆæ¯
        self.nearfield_bus.send_message(
            from_unit=self.unit_sid,
            to_unit=station_sid,
            msg_type=AIR_SAY_MESSAGE_TYPE.PASS_DOOR_ROBOT_SAY,
            payload={
                'position': self.position,
                'pass_door_position': PassDoorPosition.Inside,
            }
        )

    async def leave_station(self, station_sid: int):
        """é›¢é–‹ Station"""
        # ç™¼é€é›¢é–‹æ¶ˆæ¯
        self.nearfield_bus.send_message(
            from_unit=self.unit_sid,
            to_unit=station_sid,
            msg_type=AIR_SAY_MESSAGE_TYPE.PASS_DOOR_ROBOT_SAY,
            payload={
                'position': self.position,
                'pass_door_position': PassDoorPosition.Outside,
            }
        )

        # æ–·é–‹ 2.4G
        self.nearfield_bus.disconnect_unit(self.unit_sid)

        # æ›´æ–°ç‹€æ…‹
        self.space_state = SPACE_STATE.PLAIN
        self.purpose_state = PURPOSE_STATE.GO_POINT

    async def _heartbeat_loop(self):
        """4G å¿ƒè·³å¾ªç’° (åŒ…å« 2.4G æ¶ˆæ¯ä¸Šå ±)"""
        while True:
            # æ”¶é›† 2.4G æ¶ˆæ¯
            air_says = self.nearfield_bus.get_air_says_for_upload(self.unit_sid)
            nearfield_status = self.nearfield_bus.get_nearfield_status()

            # æ§‹å»ºå¿ƒè·³æ•¸æ“š
            heartbeat = RobotHeartbeat(
                task_uuid=self.current_task_uuid,
                space_state=self.space_state,
                purpose_state=self.purpose_state,
                battery_soc=self.battery_soc,
                is_charging=self.is_charging,
            )

            # æ§‹å»ºå®Œæ•´ä¸Šå ±æ•¸æ“š
            ping_data = RobotPingData(
                robot_say=self._build_robot_say(nearfield_status),
                air_says=air_says,
                heartbeat=heartbeat,
                nearfield_status=nearfield_status
            )

            # é€šé 4G ä¸Šå ±
            await self.grpc_client.send_meteor_events(ping_data)

            await asyncio.sleep(1)  # æ¯ç§’å¿ƒè·³

    def _build_robot_say(self, nearfield_status: bool) -> PassDoorRobotAirSay:
        """æ§‹å»º robot_say"""
        return PassDoorRobotAirSay(
            header=AirMessageHeader(
                message_type=35,
                unit_sid=self.unit_sid,
                version=self._get_version()
            ),
            say=PassDoorRobotSay(
                position=self.position,
                velocity=2000,
                angular_velocity=0,
                destination_poi_sid=self.destination_poi,
                pass_door_position=self._get_pass_door_position(),
                unit_status=UnitStatus(
                    unit_enabled=False,
                    cellular_status=True,
                    nearfield_status=nearfield_status
                )
            )
        )

    def _on_air_say_received(self, air_say: SAirSay, payload: dict):
        """æ”¶åˆ° 2.4G æ¶ˆæ¯å›èª¿"""
        print(f"[Robot] Received air_say: type={air_say.msg_type}, payload={payload}")
        # è™•ç†æ¶ˆæ¯...
```

---

## æ¸¬è©¦å ´æ™¯

### å ´æ™¯ 1: Robot é€²å…¥ Station (2.4G æ¡æ‰‹)

```python
async def test_robot_enter_station():
    """æ¸¬è©¦ Robot é€²å…¥ Station æ™‚çš„ 2.4G æ¡æ‰‹"""

    robot = RobotSimulatorV2("RBZJGF4025030001", unit_sid=10)
    station = StationSimulatorV2("STZJGF4025030067", unit_sid=20)

    # å…±äº« nearfield_bus
    shared_bus = NearfieldBus()
    robot.nearfield_bus = shared_bus
    station.nearfield_bus = shared_bus

    # å•Ÿå‹•
    await robot.start()
    await station.start()

    # Robot é€²å…¥ Station
    await robot.enter_station(station_sid=20)

    # é©—è­‰
    assert robot.nearfield_bus.get_nearfield_status() == True
    assert robot.space_state == SPACE_STATE.INSIDE_STATION

    # æª¢æŸ¥ air_says æ˜¯å¦æ­£ç¢ºç”Ÿæˆ
    air_says = robot.nearfield_bus.get_air_says_for_upload(robot.unit_sid)
    assert len(air_says) > 0
    assert air_says[0].msg_type == AIR_SAY_MESSAGE_TYPE.PASS_DOOR_ROBOT_SAY
```

### å ´æ™¯ 2: é©—è­‰ 4G ä¸Šå ±åŒ…å« air_says

```python
async def test_air_says_in_4g_upload():
    """æ¸¬è©¦ 4G å¿ƒè·³æ˜¯å¦åŒ…å« 2.4G æ¶ˆæ¯"""

    robot = RobotSimulatorV2("RBZJGF4025030001", unit_sid=10)
    await robot.start()

    # é€²å…¥ Stationï¼Œç”Ÿæˆ 2.4G æ¶ˆæ¯
    await robot.enter_station(station_sid=20)

    # ç­‰å¾…å¿ƒè·³ä¸Šå ±
    await asyncio.sleep(2)

    # æª¢æŸ¥ gRPC ç™¼é€çš„æ•¸æ“š
    # (éœ€è¦ mock grpc_client ä¾†é©—è­‰)
    sent_data = robot.grpc_client.last_sent_events

    assert 'air_says' in sent_data
    assert len(sent_data['air_says']) > 0
    assert sent_data['nearfield_status'] == True
```

---

## èˆ‡åŸè¨ˆåŠƒçš„æ•´åˆ

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å…§å®¹ |
|-----|---------|
| `common/message_bus.py` | æ›¿æ›ç‚º `nearfield_bus.py` |
| `robot/robot_simulator.py` | å¢åŠ  air_says ç”Ÿæˆé‚è¼¯ |
| `station/station_simulator.py` | å¢åŠ  2.4G æ¶ˆæ¯è™•ç† |
| `common/grpc_client.py` | ä¿®æ”¹å¿ƒè·³æ•¸æ“šçµæ§‹ |

### æ–°å¢æ–‡ä»¶

```
simulate/
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ air_say_generator.py      # SAirSay ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ nearfield_bus.py          # 2.4G æ¶ˆæ¯ç¸½ç·š (æ›¿æ› message_bus.py)
â”‚   â””â”€â”€ air_say_types.py          # 2.4G æ¶ˆæ¯é¡å‹å®šç¾©
```

---

## çµè«–

| é …ç›® | åŸè¨ˆåŠƒ | å¢å¼·å¾Œ |
|-----|-------|-------|
| **2.4G æ¨¡æ“¬æ–¹å¼** | Queue/Event | NearfieldBus + SAirSay |
| **æ¶ˆæ¯æ ¼å¼** | ç°¡åŒ– dict | ç¬¦åˆçœŸå¯¦ Base64 ç·¨ç¢¼ |
| **nearfield_status** | ç„¡ | æœ‰ |
| **4G ä¸Šå ±æ ¼å¼** | ç°¡åŒ– | åŒ…å« air_says é™£åˆ— |
| **çœŸå¯¦æ€§** | ä½ | é«˜ (å¯èˆ‡é›²å¹³å°å°æ¥) |

**å»ºè­°**ï¼šåœ¨ Phase 2 å¯¦ä½œ Station æ¨¡æ“¬å™¨æ™‚ï¼Œå…ˆå¯¦ç¾å¢å¼·çš„ `NearfieldBus` å’Œ `AirSayGenerator`ã€‚

---

**å‰µå»ºè€…**: AI Assistant
**ç‰ˆæœ¬**: v1.0
**ç›¸é—œæ–‡ä»¶**:
- `clue/delivery-actor-robot_1542.md` - å¯¦éš› log ä¾†æº
- `docs/07-dapr-actor-analysis.md` - DAPR/Actor åˆ†æ
- `docs/simulate/00-implementation-plan.md` - åŸå§‹è¨ˆåŠƒ
